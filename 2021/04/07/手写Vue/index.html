<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>手写Vue | 大枫</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","G-Z06B9NZ0K4","auto"),ga("send","pageview")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?da39e67eca8f9b3743e259caf04feb96";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">手写Vue</h1><a id="logo" href="/.">大枫</a><p class="description">Stay Hungry.Stay Foolish.</p></div><div id="nav-menu"> <a class="current" href="/."><i class="fa fa-home">首页</i></a> <a href="/archives/"><i class="fa fa-archive">归档</i></a> <a href="/about/"><i class="fa fa-user">关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">手写Vue</h1><div class="post-meta">2021-04-07 <span>|</span> <span class="category"><a href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script> <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span> <span>阅读</span></span> <span class="post-time"><span class="post-meta-item-text">|</span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i> <span class="post-count">3.6k</span> <span class="post-meta-item-text">字</span></span></span> <span class="post-time">|<span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> <span class="post-count">17</span> <span class="post-meta-item-text">分钟</span></span></span></div><a class="disqus-comment-count" href="/2021/04/07/%E6%89%8B%E5%86%99Vue/#vcomment"><span class="valine-comment-count" data-xid="/2021/04/07/%E6%89%8B%E5%86%99Vue/"></span> <span>条评论</span></a><div class="post-content"><p>目录：</p><ul><li><a href="https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/">手写Vue</a></li><li><a href="https://yongmaple.com/2021/04/26/%E6%89%8B%E5%86%99Vue%E4%BA%8C/">手写Vue二</a></li></ul><p>本文项目地址：<a target="_blank" rel="noopener" href="https://github.com/YongMaple/my-vue">https://github.com/YongMaple/my-vue</a></p><h3 id="MVVM-框架的三要素：数据响应式、模板引擎及其渲染"><a href="#MVVM-框架的三要素：数据响应式、模板引擎及其渲染" class="headerlink" title="MVVM 框架的三要素：数据响应式、模板引擎及其渲染"></a>MVVM 框架的三要素：数据响应式、模板引擎及其渲染</h3><ol><li>数据响应式：监听数据变化并在视图中更新</li></ol><ul><li>Object.defineProperty()</li><li>Proxy</li></ul><ol start="2"><li>模版引擎：提供描述视图的模版语法</li></ol><ul><li><p>插值：{ { } }</p></li><li><p>指令：v-bind，v-on，v-model，v-for，v-if</p></li></ul><ol start="3"><li>渲染：如何将模板转换为 html</li></ol><ul><li>模板 =&gt; vdom =&gt; dom</li></ul><h3 id="数据响应式原理"><a href="#数据响应式原理" class="headerlink" title="数据响应式原理"></a>数据响应式原理</h3><p>数据变更能够响应在视图中，就是数据响应式。vue2 中利⽤ Object.defineProperty() 实现变更检<br>测。</p><h3 id="实现一个简单的-reactive-js"><a href="#实现一个简单的-reactive-js" class="headerlink" title="实现一个简单的 reactive.js"></a>实现一个简单的 reactive.js</h3><p><em>Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。</em></p><p>语法</p><p><em>Object.defineProperty(obj, prop, descriptor)</em></p><p>参数</p><ul><li>obj<br>要定义属性的对象。</li><li>prop<br>要定义或修改的属性的名称或 Symbol 。</li><li>descriptor<br>要定义或修改的属性描述符。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试逻辑</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">defineReactive(obj, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">obj.foo</span><br><span class="line">obj.foo = <span class="string">&#x27;foooooooooooo&#x27;</span></span><br><span class="line">obj.foo</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node reactive.js</span><br><span class="line">get foo:foo</span><br><span class="line"><span class="built_in">set</span> foo:foooooooooooo</span><br><span class="line">get foo:foooooooooooo</span><br></pre></td></tr></table></figure><p>放到页面中，简单写一个 update 模拟一下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> val</span></span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span></span><br><span class="line">        if (newVal !== val) &#123;</span><br><span class="line"><span class="javascript">          <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span></span><br><span class="line">          val = newVal</span><br><span class="line">          update()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// app:简写 相当于document.getElementById(&#x27;app&#x27;)</span></span></span><br><span class="line">    app.innerText = obj.foo</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> obj = &#123;&#125;</span></span><br><span class="line"><span class="javascript">  defineReactive(obj, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    obj.foo = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()</span></span><br><span class="line">  &#125;, 1000)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>现在已经可以在页面中看到时间在变化了，但目前只能响应一个属性</p><h4 id="遍历需要响应的对象"><a href="#遍历需要响应的对象" class="headerlink" title="遍历需要响应的对象"></a>遍历需要响应的对象</h4><p>回到 reactive.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历obj，动态拦截obj的所有key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    defineReactive(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>目前只是遍历了浅层的属性，还需要实现递归</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 observe 之后进行赋值的对象还不能实现响应式，需要重新递归遍历</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        <span class="comment">// 对于后赋值的对象重新递归遍历</span></span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>目前动态设置的属性还不能生效，例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.dong = <span class="string">&#x27;dong&#x27;</span></span><br></pre></td></tr></table></figure><p>此时是不生效的，模仿 Vue 进行一个封装</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  defineReactive(obj, key, val)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要设置一个新的属性时，只能使用 set 方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set(obj, <span class="string">&#x27;dong&#x27;</span>, <span class="string">&#x27;dong&#x27;</span>)</span><br></pre></td></tr></table></figure><p>用户直接使用 defineReactive，这里除了 set 写起来简单之外，set 还需要处理其他逻辑，比如数组的处理。这里暂不处理</p><h3 id="开始实现-Vue"><a href="#开始实现-Vue" class="headerlink" title="开始实现 Vue"></a>开始实现 Vue</h3><p>先写测试代码，新建一个<code>vue.html</code>，引入自己写的<code>vue.js</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;counter&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line">      counter: 1,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="javascript">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line">    app.counter++</span><br><span class="line">  &#125;, 1000)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h4><ol><li><code>new Vue()</code> ⾸先执⾏初始化，对 data 执⾏响应化处理，这个过程发⽣在 Observer 中</li><li>同时对模板执⾏编译，找到其中动态绑定的数据，从 data 中获取并初始化视图，这个过程发⽣在<br>Compile 中</li><li>同时定义⼀个更新函数和 Watcher，将来对应数据变化时 Watcher 会调⽤更新函数</li><li>由于 data 的某个 key 在⼀个视图中可能出现多次，所以每个 key 都需要⼀个管家 Dep 来管理多个<br>Watcher</li><li>将来 data 中数据⼀旦发⽣变化，会⾸先找到对应的 Dep，通知所有 Watcher 执⾏更新函数</li></ol><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>先将之前的<code>defineReactive</code>和<code>observe</code>搬过来</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 递归遍历obj，动态拦截obj的所有key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    defineReactive(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="built_in">this</span>.$data = options.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对data做响应式处理</span></span><br><span class="line">    observe(<span class="built_in">this</span>.$data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个<code>Observer</code>来根据传入对象的类型做不同的相应处理</p><p>将 observe 中的 defineReactive 移到 walk 中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建Observer实例</span></span><br><span class="line">  <span class="keyword">new</span> Observer(obj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应式对象中的某个key只要是一个对象就要创建一个Observer实例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 核心功能：根据传入对象的类型做不同的相应处理</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> 数组处理</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对象响应式</span></span><br><span class="line">      <span class="built_in">this</span>.walk(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">walk</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      defineReactive(obj, key, obj[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里在调用 observe 时，会递归遍历。在平时 Vue 中看到的<code>__ob__</code>就是这个 Observer</p><p>现在还缺一层代理，在平时 Vue 中，可以通过<code>app.counter</code>的方式访问到属性，目前还只能通过<code>app.$data.counter</code>来访问</p><p>代理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(vm.$data).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(vm, key, &#123;</span><br><span class="line">      <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> vm.$data[key]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">        vm.$data[key] = newVal</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="built_in">this</span>.$data = options.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对data做响应式处理</span></span><br><span class="line">    observe(<span class="built_in">this</span>.$data)</span><br><span class="line">    <span class="comment">// 代理</span></span><br><span class="line">    proxy(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在就可以通过<code>app.counter</code>直接访问到了</p><h4 id="实现编译"><a href="#实现编译" class="headerlink" title="实现编译"></a>实现编译</h4><p>需要在遍历子元素的时候分别编译节点和文本</p><p>编译节点时，遍历其属性，对<code>v-</code>开头的分别处理，对<code>@</code>开头的绑定时间</p><p>编译文本时，判断是否有 <code>&#123;&#123;&#125;&#125;</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">el, vm</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$vm = vm</span><br><span class="line">    <span class="built_in">this</span>.$el = <span class="built_in">document</span>.querySelector(el)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历宿主元素</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.$el) &#123;</span><br><span class="line">      <span class="built_in">this</span>.compile(<span class="built_in">this</span>.$el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">compile</span>(<span class="params">el</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 递归遍历根元素</span></span><br><span class="line">    el.childNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isElement(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译元素&#x27;</span>, node.nodeName)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isInterpolation(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译插值文本&#x27;</span>, node.textContent)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 递归</span></span><br><span class="line">      <span class="keyword">if</span> (node.childNodes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.compile(node)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 元素判断</span></span><br><span class="line">  <span class="function"><span class="title">isElement</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 插值判断</span></span><br><span class="line">  <span class="function"><span class="title">isInterpolation</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 正则通过()分组，把&#123;&#123;&#125;&#125;中的内容放入RegExp中的$1</span></span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">3</span> &amp;&amp; <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>.test(node.textContent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="built_in">this</span>.$data = options.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对data做响应式处理</span></span><br><span class="line">    observe(<span class="built_in">this</span>.$data)</span><br><span class="line">    <span class="comment">// 代理</span></span><br><span class="line">    proxy(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Compile(options.el, <span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面开始解析插值文本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="title">compile</span>(<span class="params">el</span>)</span> &#123;</span><br><span class="line">    el.childNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isElement(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译元素&#x27;</span>, node.nodeName)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isInterpolation(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译插值文本&#x27;</span>, node.textContent)</span><br><span class="line">        <span class="built_in">this</span>.compileText(node)</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"> <span class="comment">// 解析插值文本</span></span><br><span class="line">  <span class="function"><span class="title">compileText</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    node.textContent = <span class="built_in">this</span>.$vm[<span class="built_in">RegExp</span>.$1]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在已经可以在页面上看到编译出来的<code>counter</code>了，不过还不会更新，因为只编译了一次，先不处理，先把编译属性处理一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="title">compile</span>(<span class="params">el</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 递归遍历根元素</span></span><br><span class="line">    el.childNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isElement(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译元素&#x27;</span>, node.nodeName)</span><br><span class="line">        <span class="built_in">this</span>.compileElement(node)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isInterpolation(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译插值文本&#x27;</span>, node.textContent)</span><br><span class="line">        <span class="built_in">this</span>.compileText(node)</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 编译元素</span></span><br><span class="line">  <span class="function"><span class="title">compileElement</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历所有属性：检查是否存在指令和事件</span></span><br><span class="line">    <span class="keyword">const</span> attrs = node.attributes</span><br><span class="line">    <span class="built_in">Array</span>.from(attrs).forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr)</span><br><span class="line">      <span class="comment">// 例如：v-text=&quot;counter&quot;</span></span><br><span class="line">      <span class="comment">// attrName就是v-text</span></span><br><span class="line">      <span class="comment">// expression就是counter</span></span><br><span class="line">      <span class="keyword">const</span> attrName = attr.name</span><br><span class="line">      <span class="keyword">const</span> expression = attr.value</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只处理动态值</span></span><br><span class="line">      <span class="comment">// 指令 v-</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(attrName)) &#123;</span><br><span class="line">        <span class="comment">// 希望执行一个指令处理函数</span></span><br><span class="line">        <span class="keyword">const</span> directive = attrName.substring(<span class="number">2</span>)</span><br><span class="line">        <span class="comment">// 如果存在这个指令对应的函数就执行，比如v-text就执行text()</span></span><br><span class="line">        <span class="built_in">this</span>[directive] &amp;&amp; <span class="built_in">this</span>[directive](node, expression)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断指令</span></span><br><span class="line">  <span class="function"><span class="title">isDirective</span>(<span class="params">attrName</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> attrName.startsWith(<span class="string">&#x27;v-&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先处理一个 <code>v-text</code>，添加如下方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-text</span></span><br><span class="line"><span class="function"><span class="title">text</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  node.textContent = <span class="built_in">this</span>.$vm[expression]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在页面中添加<code>&lt;p v-text=&quot;counter&quot;&gt;&lt;/p&gt;</code>，已经可以正常显示了</p><p>再添加一个<code>v-html</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-html</span></span><br><span class="line"><span class="function"><span class="title">html</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  node.innerHTML = <span class="built_in">this</span>.$vm[expression]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>页面上添加</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-html</span>=<span class="string">&quot;desc&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line">      counter: 1,</span><br><span class="line"><span class="handlebars"><span class="xml">      desc: &#x27;foo<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color:red&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同样生效了</p><h4 id="依赖收集"><a href="#依赖收集" class="headerlink" title="依赖收集"></a>依赖收集</h4><p>给每个 key 创建一个 Dep，用来管理这个 key 的 Watcher</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> watchers = []</span><br><span class="line"><span class="comment">// 更新执行者Watcher</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">vm, key, updater</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.vm = vm</span><br><span class="line">    <span class="built_in">this</span>.key = key</span><br><span class="line">    <span class="built_in">this</span>.updater = updater</span><br><span class="line"></span><br><span class="line">    watchers.push(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updater.call(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先不做依赖收集，简单的把 watcher 放到 watchers 数组中</p><p>改造<code>Compile</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// v-text</span></span><br><span class="line">  <span class="function"><span class="title">text</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.update(node, expression, <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">textUpdater</span>(<span class="params">node, val</span>)</span> &#123;</span><br><span class="line">    node.textContent = val</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params">node, expression, directive</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 在解析指令时，不光要给它初始化，还要给它做更新函数的创建</span></span><br><span class="line">    <span class="comment">// 执行directive对应的实操函数</span></span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">this</span>[directive + <span class="string">&#x27;Updater&#x27;</span>]</span><br><span class="line">    fn &amp;&amp; fn(node, <span class="built_in">this</span>.$vm[expression])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Watcher</span></span><br><span class="line">    <span class="keyword">new</span> Watcher(<span class="built_in">this</span>.$vm, expression, <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 形成闭包</span></span><br><span class="line">      fn &amp;&amp; fn(node, val)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造<code>defineReactive</code>，每次 set 时把 watchers 遍历</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">        <span class="comment">// update()</span></span><br><span class="line">        watchers.forEach(<span class="function">(<span class="params">w</span>) =&gt;</span> w.update())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在<code>v-text</code>已经可以更新了</p><p>改造插值文本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析插值文本</span></span><br><span class="line"><span class="function"><span class="title">compileText</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.update(node, <span class="built_in">RegExp</span>.$1, <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造<code>v-html</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-html</span></span><br><span class="line"><span class="function"><span class="title">html</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.update(node, expression, <span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">htmlUpdater</span>(<span class="params">node, val</span>)</span> &#123;</span><br><span class="line">  node.innerHTML = val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面是通过 watchers 是全量更新，现在创建 Dep，用来收集每个 key 的 watcher</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.deps = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">addDep</span>(<span class="params">dep</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.deps.push(dep)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">notify</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.deps.forEach(<span class="function">(<span class="params">w</span>) =&gt;</span> w.update())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造 defineReactive 和 Watcher</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个对应的Dep实例</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep() <span class="comment">// 这里也是闭包，dep和key是一对一的对应关系</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 依赖收集</span></span><br><span class="line">      Dep.target &amp;&amp; dep.addDep(Dep.target)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">        <span class="comment">// update()</span></span><br><span class="line">        <span class="comment">// watchers.forEach((w) =&gt; w.update())</span></span><br><span class="line">        dep.notify()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">vm, key, updater</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.vm = vm</span><br><span class="line">    <span class="built_in">this</span>.key = key</span><br><span class="line">    <span class="built_in">this</span>.updater = updater</span><br><span class="line"></span><br><span class="line">    <span class="comment">// watchers.push(this)</span></span><br><span class="line">    <span class="comment">// 保存Watcher引用，放到静态变量里</span></span><br><span class="line">    Dep.target = <span class="built_in">this</span></span><br><span class="line">    <span class="comment">// 放进去立刻读取，触发defineReactive中的get</span></span><br><span class="line">    <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key]</span><br><span class="line">    Dep.target = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updater.call(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数组响应式"><a href="#数组响应式" class="headerlink" title="数组响应式"></a>数组响应式</h3><ol><li>找到数组原型</li><li>覆盖那些能够修改数组的更新方法，使其可以通知更新</li><li>将得到的新的原型设置到数组实例原型上</li></ol><p>先处理原型</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组响应式</span></span><br><span class="line"><span class="comment">// 1. 替换数组原型中7个方法</span></span><br><span class="line"><span class="keyword">const</span> orginalProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="comment">// 备份，修改此备份</span></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Object</span>.create(orginalProto)</span><br><span class="line"></span><br><span class="line">;[<span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;unshift&#x27;</span>, <span class="string">&#x27;reverse&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;splice&#x27;</span>].forEach(</span><br><span class="line">  (method) =&gt; &#123;</span><br><span class="line">    arrayProto[method] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 原始操作</span></span><br><span class="line">      orginalProto[method].apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">      <span class="comment">// 覆盖操作：通知更新</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`数组执行：<span class="subst">$&#123;method&#125;</span>操作`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>应用新的原型</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 核心功能：根据传入对象的类型做不同的相应处理</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">      <span class="comment">// 数组处理</span></span><br><span class="line">      <span class="comment">// 覆盖原型，替换7个变更操作</span></span><br><span class="line">      obj.__proto__ = arrayProto</span><br><span class="line">      <span class="comment">// 对数组内部元素执行响应化</span></span><br><span class="line">      <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        observe(obj[i])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对象响应式</span></span><br><span class="line">      <span class="built_in">this</span>.walk(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">walk</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      defineReactive(obj, key, obj[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单测试，改下 vue.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line">      counter: 1,</span><br><span class="line"><span class="handlebars"><span class="xml">      desc: &#x27;foo<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color:red&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27;,</span></span></span><br><span class="line">      arr: [],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="javascript">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line">    app.counter++</span><br><span class="line">  &#125;, 1000)</span><br><span class="line"><span class="javascript">  app.arr.push(<span class="string">&#x27;foo&#x27;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h3><p>和指令一样，先判断，再写一个处理函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 编译元素</span></span><br><span class="line">  <span class="function"><span class="title">compileElement</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历所有属性：检查是否存在指令和事件</span></span><br><span class="line">    <span class="keyword">const</span> attrs = node.attributes</span><br><span class="line">    <span class="built_in">Array</span>.from(attrs).forEach(<span class="function">(<span class="params">attr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr)</span><br><span class="line">      <span class="comment">// 例如：v-text=&quot;counter&quot;</span></span><br><span class="line">      <span class="comment">// attrName就是v-text</span></span><br><span class="line">      <span class="comment">// expression就是counter</span></span><br><span class="line">      <span class="keyword">const</span> attrName = attr.name</span><br><span class="line">      <span class="keyword">const</span> expression = attr.value</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只处理动态值</span></span><br><span class="line">      <span class="comment">// 指令 v-</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(attrName)) &#123;</span><br><span class="line">        <span class="comment">// 希望执行一个指令处理函数</span></span><br><span class="line">        <span class="keyword">const</span> directive = attrName.substring(<span class="number">2</span>)</span><br><span class="line">        <span class="comment">// 如果存在这个指令对应的函数就执行，比如v-text就执行text()</span></span><br><span class="line">        <span class="built_in">this</span>[directive] &amp;&amp; <span class="built_in">this</span>[directive](node, expression)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 判断事件</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isEvent(attrName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> event = attrName.substring(<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">this</span>.eventHandler(node, expression, event)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">eventHandler</span>(<span class="params">node, expression, event</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">this</span>.$vm.$options.methods &amp;&amp; <span class="built_in">this</span>.$vm.$options.methods[expression]</span><br><span class="line">    node.addEventListener(event, fn.bind(<span class="built_in">this</span>.$vm))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断事件</span></span><br><span class="line">  <span class="function"><span class="title">isEvent</span>(<span class="params">attrName</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> attrName.startsWith(<span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>测试一下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-html</span>=<span class="string">&quot;desc&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;onClick&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line">    ...</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;barrrrr&#x27;</span>)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="双向绑定"><a href="#双向绑定" class="headerlink" title="双向绑定"></a>双向绑定</h3><p>v-model 实际上是语法糖，解决 value 设定和事件监听</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-model</span></span><br><span class="line"><span class="function"><span class="title">model</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// update方法只完成赋值和更新</span></span><br><span class="line">  <span class="built_in">this</span>.update(node, expression, <span class="string">&#x27;model&#x27;</span>)</span><br><span class="line">  <span class="comment">// 事件监听</span></span><br><span class="line">  node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 将新的值赋值给数据</span></span><br><span class="line">    <span class="built_in">this</span>.$vm[expression] = e.target.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">modelUpdater</span>(<span class="params">node, val</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 给表单元素赋值</span></span><br><span class="line">  node.value = val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里只考虑了 input，其他不考虑</p><p>测试代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;desc&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>本文完</strong></p></div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="复制成功!"></script><a class="pos-f tr3" id="github" target="_blank" rel="noopener" href="https://github.com/YongMaple" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/AliPayQR.jpg"></li><li id="WeChat" qr="/img/WeChatQR.jpg"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/" data-id="ckqypjo0a006q3kq21uqohjlj" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKUlEQVR42u3aQWoDMQwF0Nz/0il0FQjJfElOaezn1dBpPX4uCNnS7RaP++94fH78yfPPn8f72d7PvGxgYGB8LSP5fPLhHjXfsou/xcDAOIDRC7J59Mt/59XzxZoxMDAw4iCYLygJ0xgYGBjzgDtZXHUjMDAwMJLpkgBaTRwnwR0DA+McRq8w8DfPH69vYGBg/HvGvTiqKWAecEerwsDA2JpRTfLyo2k1vE5SUgwMjBMYvWavXrbWC8SFAzMGBsamjLwAOWmh6DVhFN5iYGBsysiLi71DZp4UVssGGBgY5zAm5YHq2zw0J5u4rMqBgYHxJYzeBX2vnaKXXEZNYxgYGJsyJtdn1bTvfejMGy8uKrEYGBibMuZNWlVMnghGAR0DA+NgRvXqP2+YyI/BCwIuBgbG1ozCRK3QXA3fF20WGBgYmzLya7Ve6TF522sFu6jHYmBgbMRIpqimgPMSZnUlGBgY5zDy6fKy5eQQm6enGBgYezOShc57zSaw5lEWAwNjI0begLWqFSPZlHKZEwMD4wDGPF2bFDurwf3lfSEGBsamjDx1q36gWiTopYkX/xMMDIwtGPfi+MQFXO8tBgbGOYxqubH6nBcm829hYGCcyei1ha3arfJh9dU2YWBgHMBIwmK+xPztglM4BgYGRvHDyVXd5DKu2RCGgYFxJKN3DVfdgsJGYGBgHMBIDrHV4+uqtrCEioGBsTejeoDsLTRvIxsliBgYGLsxfgBNj7JQEFdiRgAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"><i class="fa fa-tag"></i>手撕源码</a><a href="/tags/Vue/"><i class="fa fa-tag"></i>Vue</a></div><div class="post-nav"><a class="pre" href="/2021/04/08/AntV-L7%E4%B8%AD%E7%94%BB%E4%B8%80%E4%B8%AA%E6%8C%87%E5%AE%9A%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%9C%86/">AntV-L7中画一个指定距离的圆</a><a class="next" href="/2021/04/01/Vue%E5%85%A8%E5%AE%B6%E6%A1%B6&amp;%E5%8E%9F%E7%90%86/">Vue全家桶&amp;原理</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify=!1,verify=!1,GUEST_INFO=["nick","mail","link"],guest_info="nick,mail,link".split(",").filter(function(i){return-1<GUEST_INFO.indexOf(i)});guest_info=0==guest_info.length?GUEST_INFO:guest_info,window.valine=new Valine({el:"#vcomment",notify:notify,verify:verify,appId:"I3xP7RQ9tkxTDanFl9uqQVz5-gzGzoHsz",appKey:"ES3vn5QS7Nr60OgnmwKqCkv9",placeholder:"写点什么吧",avatar:"retro",guest_info:guest_info,pageSize:"10"})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"><input type="hidden" name="si" value="https://yongmaple.com"><input name="tn" type="hidden" value="bds"><input name="cl" type="hidden" value="3"><input name="ct" type="hidden" value="2097152"><input name="s" type="hidden" value="on"></form></div><div class="widget"><div class="widget-title"> <i class="fa fa-folder-o">分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%80%9D%E7%BB%B4/">思维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%A5%E9%94%99/">报错</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%B0%E5%BF%86/">记忆</a></li></ul></div><div class="widget"><div class="widget-title"> <i class="fa fa-star-o">标签</i></div><div class="tagcloud"><a href="/tags/%E8%AE%B0%E5%BF%86%E5%AE%AB%E6%AE%BF/" style="font-size:15px">记忆宫殿</a> <a href="/tags/AntD/" style="font-size:15px">AntD</a> <a href="/tags/AntV/" style="font-size:15px">AntV</a> <a href="/tags/L7/" style="font-size:15px">L7</a> <a href="/tags/Atom/" style="font-size:15px">Atom</a> <a href="/tags/eslint/" style="font-size:15px">eslint</a> <a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" style="font-size:15px">开发工具</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size:15px">配置</a> <a href="/tags/css/" style="font-size:15px">css</a> <a href="/tags/Oh-My-ZSH/" style="font-size:15px">Oh-My-ZSH</a> <a href="/tags/CentOS/" style="font-size:15px">CentOS</a> <a href="/tags/egg-js/" style="font-size:15px">egg.js</a> <a href="/tags/redis/" style="font-size:15px">redis</a> <a href="/tags/Cesium/" style="font-size:15px">Cesium</a> <a href="/tags/ES6/" style="font-size:15px">ES6</a> <a href="/tags/ESlint/" style="font-size:15px">ESlint</a> <a href="/tags/title/" style="font-size:15px">title</a> <a href="/tags/ios/" style="font-size:15px">ios</a> <a href="/tags/%E6%89%8B%E6%9C%BA%E7%AB%AF/" style="font-size:15px">手机端</a> <a href="/tags/JavaScript/" style="font-size:15px">JavaScript</a> <a href="/tags/JS/" style="font-size:15px">JS</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size:15px">基础</a> <a href="/tags/%E8%BD%AC%E6%8D%A2/" style="font-size:15px">转换</a> <a href="/tags/%E5%8F%82%E6%95%B0/" style="font-size:15px">参数</a> <a href="/tags/forEach/" style="font-size:15px">forEach</a> <a href="/tags/map/" style="font-size:15px">map</a> <a href="/tags/includes/" style="font-size:15px">includes</a> <a href="/tags/indexOf/" style="font-size:15px">indexOf</a> <a href="/tags/%E6%95%B0%E7%BB%84/" style="font-size:15px">数组</a> <a href="/tags/%E6%8B%BC%E6%8E%A5/" style="font-size:15px">拼接</a> <a href="/tags/match/" style="font-size:15px">match</a> <a href="/tags/exec/" style="font-size:15px">exec</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size:15px">正则</a> <a href="/tags/sort/" style="font-size:15px">sort</a> <a href="/tags/%E6%AF%94%E8%BE%83/" style="font-size:15px">比较</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size:15px">前端</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size:15px">排序</a> <a href="/tags/React/" style="font-size:15px">React</a> <a href="/tags/%E6%BA%90%E4%BB%A3%E7%A0%81%E6%9F%A5%E7%9C%8B/" style="font-size:15px">源代码查看</a> <a href="/tags/nodejs/" style="font-size:15px">nodejs</a> <a href="/tags/Mac/" style="font-size:15px">Mac</a> <a href="/tags/%E8%BE%93%E5%85%A5%E6%B3%95/" style="font-size:15px">输入法</a> <a href="/tags/mongodb/" style="font-size:15px">mongodb</a> <a href="/tags/mongoose/" style="font-size:15px">mongoose</a> <a href="/tags/%E6%8A%A5%E9%94%99/" style="font-size:15px">报错</a> <a href="/tags/nextTick/" style="font-size:15px">nextTick</a> <a href="/tags/hooks/" style="font-size:15px">hooks</a> <a href="/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/" style="font-size:15px">手撕源码</a> <a href="/tags/Menu/" style="font-size:15px">Menu</a> <a href="/tags/%E9%80%82%E9%85%8D/" style="font-size:15px">适配</a> <a href="/tags/Retina/" style="font-size:15px">Retina</a> <a href="/tags/Vim/" style="font-size:15px">Vim</a> <a href="/tags/Vite/" style="font-size:15px">Vite</a> <a href="/tags/Vue/" style="font-size:15px">Vue</a> <a href="/tags/Vue3/" style="font-size:15px">Vue3</a> <a href="/tags/websocket/" style="font-size:15px">websocket</a> <a href="/tags/vue-router/" style="font-size:15px">vue-router</a> <a href="/tags/vuex/" style="font-size:15px">vuex</a> <a href="/tags/%E7%BB%84%E4%BB%B6%E5%8C%96/" style="font-size:15px">组件化</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size:15px">面试</a> <a href="/tags/mysql/" style="font-size:15px">mysql</a> <a href="/tags/navicat/" style="font-size:15px">navicat</a> <a href="/tags/iOS/" style="font-size:15px">iOS</a> <a href="/tags/iTerm2/" style="font-size:15px">iTerm2</a> <a href="/tags/indexedDB/" style="font-size:15px">indexedDB</a> <a href="/tags/%E9%94%AE%E7%9B%98/" style="font-size:15px">键盘</a> <a href="/tags/this/" style="font-size:15px">this</a> <a href="/tags/vscode/" style="font-size:15px">vscode</a> <a href="/tags/webpack/" style="font-size:15px">webpack</a> <a href="/tags/host/" style="font-size:15px">host</a> <a href="/tags/%E7%AC%94%E8%AF%95/" style="font-size:15px">笔试</a> <a href="/tags/MongoDB/" style="font-size:15px">MongoDB</a> <a href="/tags/android%E6%A8%A1%E6%8B%9F%E5%99%A8/" style="font-size:15px">android模拟器</a> <a href="/tags/webview/" style="font-size:15px">webview</a> <a href="/tags/Chrome/" style="font-size:15px">Chrome</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size:15px">调试</a> <a href="/tags/%E5%BE%AE%E4%BF%A1/" style="font-size:15px">微信</a> <a href="/tags/translate3d/" style="font-size:15px">translate3d</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%80%82%E9%85%8D/" style="font-size:15px">移动端适配</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:15px">算法</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size:15px">翻译</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:15px">设计模式</a></div></div><div class="widget"><div class="widget-title"> <i class="fa fa-file-o">最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/07/10/React%E7%BB%84%E4%BB%B6%E5%8C%96/">React组件化</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/31/Vue3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/">Vue3源码解析三</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/31/Vue3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/">Vue3源码解析二</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/26/Vue3%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Vue3源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/24/indexedDB%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/">indexedDB中遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/21/%E5%89%8D%E7%AB%AF%E7%AC%94%E8%AF%95%E9%A2%98%E9%9B%86%E5%90%88/">前端笔试题集合</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/20/Vue%E9%A1%B9%E7%9B%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">Vue项目最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/18/Vue%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91/">Vue组件化开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/18/110%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E7%BC%96%E7%A0%81/">110数字图像编码</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/">Vue面试题</a></li></ul></div><div class="widget"><div class="widget-title"> <i class="fa fa-external-link">友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">大枫.</a> <a rel="nofollow" target="_blank" href="https://hexo.io">驱动 Hexo.</a> <a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo">主题 maupassant.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>