<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>大枫</title>
  
  <subtitle>Stay Hungry.Stay Foolish.</subtitle>
  <link href="https://yongmaple.com/atom.xml" rel="self"/>
  
  <link href="https://yongmaple.com/"/>
  <updated>2021-05-21T10:30:37.054Z</updated>
  <id>https://yongmaple.com/</id>
  
  <author>
    <name>YongMaple</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>前端笔试题集合</title>
    <link href="https://yongmaple.com/2021/05/21/%E5%89%8D%E7%AB%AF%E7%AC%94%E8%AF%95%E9%A2%98%E9%9B%86%E5%90%88/"/>
    <id>https://yongmaple.com/2021/05/21/%E5%89%8D%E7%AB%AF%E7%AC%94%E8%AF%95%E9%A2%98%E9%9B%86%E5%90%88/</id>
    <published>2021-05-21T14:53:22.000Z</published>
    <updated>2021-05-21T10:30:37.054Z</updated>
    
    <content type="html"><![CDATA[<h4 id="不定期更新，以下都是我遇到过或看到过的真实面试题，答案均为自己做的，如果有不同意见，请留言指正"><a href="#不定期更新，以下都是我遇到过或看到过的真实面试题，答案均为自己做的，如果有不同意见，请留言指正" class="headerlink" title="不定期更新，以下都是我遇到过或看到过的真实面试题，答案均为自己做的，如果有不同意见，请留言指正"></a>不定期更新，以下都是我遇到过或看到过的真实面试题，答案均为自己做的，如果有不同意见，请留言指正</h4><ol><li>用 css 实现布局：左侧区域固定宽度 220px，右侧区域自适应（右侧顶部有 64px 高度的 header）</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">  .wrap &#123;</span><br><span class="line"><span class="css">    <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="css">    <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="css">    <span class="attribute">display</span>: grid;</span></span><br><span class="line"><span class="css">    grid-template-<span class="attribute">columns</span>: <span class="number">220px</span> <span class="number">1</span>fr;</span></span><br><span class="line"><span class="css">    grid-template-rows: <span class="number">64px</span> <span class="number">1</span>fr;</span></span><br><span class="line">    grid-template-areas:</span><br><span class="line">      &#x27;left header&#x27;</span><br><span class="line">      &#x27;left main&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line">  .left &#123;</span><br><span class="line"><span class="css">    grid-area: left;</span></span><br><span class="line">  &#125;</span><br><span class="line">  .header &#123;</span><br><span class="line"><span class="css">    grid-area: header;</span></span><br><span class="line">  &#125;</span><br><span class="line">  .main &#123;</span><br><span class="line"><span class="css">    grid-area: main;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>将一个整型数组 A 作为参数传递给一个函数 B，B 函数内部修改传递进来的整型数组的第一个元素值，执行完 B 函数后，数组 A 中的元素值是否发生变化？解释其原因</li></ol><p>会发生变化，因为数组是对象，对象传递时是传递的内存地址（引用传递），实际地址指向是同一个对象</p><ol start="3"><li>创建 10 个 a 标签，点击输出其序号</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom = <span class="built_in">document</span>.createElement(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">  dom.innerText = i</span><br><span class="line">  dom.onclick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    alert(i)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>请实现一个函数，可将无限层级的数组进行展平。比如：<code>[1,[2,[3,4]],5]</code>，展平后为<code>[1,2,3,4,5]</code></li></ol><p>最简单的方式，用 flat，默认展开 1 级，Infinity 表示无限层级</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> original = [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>]], <span class="number">5</span>]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unflod</span>(<span class="params">original</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> original.flat(<span class="literal">Infinity</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>递归的方式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> original = [<span class="number">1</span>, [<span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>]], <span class="number">5</span>]</span><br><span class="line"><span class="keyword">const</span> result = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unfold</span>(<span class="params">original</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; original.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = original[i]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(item)) &#123;</span><br><span class="line">      unfold(item)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.push(item)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">unfold(original)</span><br><span class="line"><span class="built_in">console</span>.log(result)</span><br></pre></td></tr></table></figure><ol start="5"><li>寻找单数，整数集合中有 2n+1 个数，其中 2n 个数两两相同，寻找剩下对单数，如：<code>[2,3,6,3,6,1,1]</code>，输出：2</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    result ^= arr[i]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(fn([<span class="number">2</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">1</span>]))</span><br></pre></td></tr></table></figure><ol start="6"><li>请实现 Promise.all 与 Promise.race 方法</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;不定期更新，以下都是我遇到过或看到过的真实面试题，答案均为自己做的，如果有不同意见，请留言指正&quot;&gt;&lt;a href=&quot;#不定期更新，以下都是我遇到过或看到过的真实面试题，答案均为自己做的，如果有不同意见，请留言指正&quot; class=&quot;headerlink&quot; title</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="面试" scheme="https://yongmaple.com/tags/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="笔试" scheme="https://yongmaple.com/tags/%E7%AC%94%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://yongmaple.com/2021/05/21/test/"/>
    <id>https://yongmaple.com/2021/05/21/test/</id>
    <published>2021-05-21T10:30:37.050Z</published>
    <updated>2021-05-21T10:30:37.050Z</updated>
    
    <content type="html"><![CDATA[<!DOCTYPE html><html lang="en"><head>  <meta charset="UTF-8">  <meta http-equiv="X-UA-Compatible" content="IE=edge">  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <title>Document</title>  <style>    .wrap {      width: 100%;      height: 100%;      display: grid;      grid-template-columns: 220px 1fr;      grid-template-rows: 64px 1fr;      grid-template-areas: 'left header'        'left main';    }    .left {      grid-area: left;    }    .header {      grid-area: header;    }    .main {      grid-area: main;    }  </style></head><body>  <div class="wrap">    <div class="left"></div>    <div class="header"></div>    <div class="main"></div>  </div></body><script>  for (let i = 0; i < 10; i++) {    const dom = document.createElement('a')    dom.innerText = i    dom.onclick = () => {      alert(i)    }    document.body.appendChild(dom)  }  const original = [1, [2, [3, 4]], 5]  // const result = original.flat(Infinity)  const result = [];  function unfold(original) {    for (let i = 0; i < original.length; i++) {      const item = original[i];      if (Array.isArray(item)) {        unfold(item);      } else {        result.push(item);      }    }  }  unfold(original)  console.log(result)  function fn(arr) {    let result = 0    for (let i = 0; i < arr.length; i++) {      result ^= arr[i]    }    return result  }  console.log(fn([2, 3, 6, 3, 6, 1, 1]))</script></html>]]></content>
    
    
      
      
    <summary type="html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
  &lt;meta name=&quot;view</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Vue项目最佳实践</title>
    <link href="https://yongmaple.com/2021/05/20/Vue%E9%A1%B9%E7%9B%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <id>https://yongmaple.com/2021/05/20/Vue%E9%A1%B9%E7%9B%AE%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</id>
    <published>2021-05-20T14:27:19.000Z</published>
    <updated>2021-05-21T10:30:37.050Z</updated>
    
    <content type="html"><![CDATA[<h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>这里使用的是<code>@vue/cli 4.5.13</code>，简单的新建了一个vue2的项目</p><h3 id><a href="#" class="headerlink" title></a></h3>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;版本&quot;&gt;&lt;a href=&quot;#版本&quot; class=&quot;headerlink&quot; title=&quot;版本&quot;&gt;&lt;/a&gt;版本&lt;/h3&gt;&lt;p&gt;这里使用的是&lt;code&gt;@vue/cli 4.5.13&lt;/code&gt;，简单的新建了一个vue2的项目&lt;/p&gt;
&lt;h3 id&gt;&lt;a href=</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>Vue组件化开发</title>
    <link href="https://yongmaple.com/2021/05/18/Vue%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91/"/>
    <id>https://yongmaple.com/2021/05/18/Vue%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91/</id>
    <published>2021-05-18T16:14:49.000Z</published>
    <updated>2021-05-21T10:30:37.046Z</updated>
    
    <content type="html"><![CDATA[<h3 id="组件通信常用方式"><a href="#组件通信常用方式" class="headerlink" title="组件通信常用方式"></a>组件通信常用方式</h3><ul><li>props</li><li>$emit/$on</li><li>event bus</li><li>vuex</li></ul><h3 id="边界情况"><a href="#边界情况" class="headerlink" title="边界情况"></a>边界情况</h3><ul><li>$parent</li><li>$children</li><li>$root</li><li>$refs</li><li>provide/inject</li><li>非 prop 特性<ul><li>$attrs</li><li>$listeners</li></ul></li></ul><h4 id="事件总线的实现方式"><a href="#事件总线的实现方式" class="headerlink" title="事件总线的实现方式"></a>事件总线的实现方式</h4><p>原生实现</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bus</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.callbacks = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  $on(name, fn) &#123;</span><br><span class="line">    <span class="built_in">this</span>.callbacks[name] = <span class="built_in">this</span>.callbacks[name] || []</span><br><span class="line">    <span class="built_in">this</span>.callbacks[name].push(fn)</span><br><span class="line">  &#125;</span><br><span class="line">  $emit(name, args) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.callbacks[name]) &#123;</span><br><span class="line">      <span class="built_in">this</span>.callbacks[name].forEach(<span class="function"><span class="params">cb</span> =&gt;</span> cb(args))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line">Vue.prototype.$bus = <span class="keyword">new</span> Bus()</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="comment">// child1</span></span><br><span class="line"><span class="built_in">this</span>.$bus.$on(<span class="string">&#x27;foo&#x27;</span>, handle)</span><br><span class="line"><span class="comment">// chiild2</span></span><br><span class="line"><span class="built_in">this</span>.$bus.$emit(<span class="string">&#x27;foo)</span></span><br></pre></td></tr></table></figure><p>通常直接用 Vue 代替 Bus，因为 Vue 已经实现了$on和$emit</p><h4 id="parent-root"><a href="#parent-root" class="headerlink" title="$parent/$root"></a>$parent/$root</h4><p>兄弟组件之间通信可通过共同祖辈搭桥，$parent或$root</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// brother1</span></span><br><span class="line"><span class="built_in">this</span>.$parent.$on(<span class="string">&#x27;foo&#x27;</span>, handle)</span><br><span class="line"><span class="comment">// brother2</span></span><br><span class="line"><span class="built_in">this</span>.$parent.$emit(<span class="string">&#x27;foo&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="children"><a href="#children" class="headerlink" title="$children"></a>$children</h4><p>父组件可以通过$children 访问子组件实现父子通信</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parent</span></span><br><span class="line"><span class="built_in">this</span>.$children[<span class="number">0</span>].xx = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line"><span class="comment">// $children不能保证子元素顺序</span></span><br></pre></td></tr></table></figure><h4 id="refs"><a href="#refs" class="headerlink" title="$refs"></a>$refs</h4><p>获取子节点引用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parent</span></span><br><span class="line">&lt;HelloWorld ref=<span class="string">&#x27;hw&#x27;</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.$refs.hw.xx = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="attrs-listeners"><a href="#attrs-listeners" class="headerlink" title="$attrs/$listeners"></a>$attrs/$listeners</h4><p>包含了父作用域中<em>不作为 prop 被识别</em>的特性绑定（class 和 style 除外）。当一个组件没有声明任何 prop 时，这里会包含所有父作用域的绑定（class 和 style 除外），并且可以通过<code>v-bind=&quot;$attrs&quot;</code>传入内部组件，在创建高级别的组件时非常有用</p><p>非属性特性：没在 props 中声明，但是使用了的属性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// child：并未在props中声明foo</span></span><br><span class="line">&lt;p&gt;&#123;&#123;$attrs.foo&#125;&#125;&lt;/p&gt;</span><br><span class="line"><span class="comment">// parent</span></span><br><span class="line">&lt;HelloWorld foo=<span class="string">&quot;foo&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 给Grandson隔代传值</span></span><br><span class="line">&lt;Child2 msg=<span class="string">&quot;lalala&quot;</span> @some-event=<span class="string">&quot;onSomeEvent&quot;</span>&gt;&lt;/Child2&gt;</span><br><span class="line"><span class="comment">// child2做展开</span></span><br><span class="line">&lt;Grandson v-bind=<span class="string">&quot;$attrs&quot;</span> v-on=<span class="string">&quot;$listeners&quot;</span>&gt;&lt;/Grandson&gt;</span><br><span class="line"><span class="comment">// Grandson使用</span></span><br><span class="line">&lt;div @click=<span class="string">&quot;$emit(&#x27;some-event&#x27;, &#x27;msg from grandson&#x27;)&quot;</span>&gt;&#123;&#123;msg&#125;&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p><strong>可以使用<code>inheritAttrs: false</code>防止属性透传</strong></p><h4 id="provide-inject"><a href="#provide-inject" class="headerlink" title="provide/inject"></a>provide/inject</h4><p>能够实现祖先和后代之间传值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="title">provide</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">foo</span>: <span class="string">&#x27;foo&#x27;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">inject: [<span class="string">&#x27;foo&#x27;</span>]</span><br></pre></td></tr></table></figure><p>官方中 provide/inject 不是响应式的，如果想实现响应式，只需要传入 this 就可以了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">provide</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    grandpa: <span class="built_in">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>inject 优先级高于 prop（inject &gt; props &gt; methods &gt; data），如果重名，会报错</p><p>重命名及默认值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">inject: &#123;</span><br><span class="line">  foo2: <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">inject: &#123;</span><br><span class="line">  foo: &#123;</span><br><span class="line">    <span class="keyword">from</span>: <span class="string">&#x27;foo&#x27;</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">&#x27;default foo&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="插槽"><a href="#插槽" class="headerlink" title="插槽"></a>插槽</h3><p>插槽语法是 Vue 实现的内容分发 API，用于复合组件开发。该技术在通用组件库开发中有大量应用。</p><h4 id="匿名插槽"><a href="#匿名插槽" class="headerlink" title="匿名插槽"></a>匿名插槽</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// comp1</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;slot&gt;&lt;/slot&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// parent</span></span><br><span class="line">&lt;comp&gt;hello&lt;/comp&gt;</span><br></pre></td></tr></table></figure><h4 id="具名插槽"><a href="#具名插槽" class="headerlink" title="具名插槽"></a>具名插槽</h4><p>将内容分发到子组件指定位置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// comp2</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;slot&gt;&lt;/slot&gt;</span><br><span class="line">  &lt;slot name=<span class="string">&quot;content&quot;</span>&gt;&lt;/slot&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="comment">// parent</span></span><br><span class="line">&lt;comp2&gt;</span><br><span class="line">  &lt;!-- 默认插槽用<span class="keyword">default</span>做参数 --&gt;</span><br><span class="line">  &lt;template v-slot:<span class="keyword">default</span>&gt;具名插槽&lt;/template&gt;</span><br><span class="line">  &lt;!-- 具名插槽用插槽名做参数 --&gt;</span><br><span class="line">  &lt;template v-slot:content&gt;内容&lt;/template&gt;</span><br><span class="line">&lt;/comp2&gt;</span><br></pre></td></tr></table></figure><h4 id="作用域插槽"><a href="#作用域插槽" class="headerlink" title="作用域插槽"></a>作用域插槽</h4><p>分发内容要用到子组件中的数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// comp3</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;slot :foo=<span class="string">&quot;foo&quot;</span>&gt;&lt;/slot&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="comment">// parent</span></span><br><span class="line">&lt;comp3&gt;</span><br><span class="line">  &lt;!-- 把v-slot的值指定为作用域上下文对象 --&gt;</span><br><span class="line">  &lt;template v-slot:<span class="keyword">default</span>=<span class="string">&quot;slotProps&quot;</span>&gt;</span><br><span class="line">    来自子组件数据：&#123;&#123;slotProps.foo&#125;&#125;</span><br><span class="line">  &lt;/template&gt;</span><br><span class="line">&lt;/comp3&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><h4 id="input"><a href="#input" class="headerlink" title="input"></a>input</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 双绑：</span></span><br><span class="line"><span class="comment">    1.:value</span></span><br><span class="line"><span class="comment">    2.@input --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">:type</span>=<span class="string">&quot;type&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;value&quot;</span> @<span class="attr">input</span>=<span class="string">&quot;onInput&quot;</span> <span class="attr">v-bind</span>=<span class="string">&quot;$attrs&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    inheritAttrs: <span class="literal">false</span>,</span></span><br><span class="line">    props: &#123;</span><br><span class="line">      value: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">        required: <span class="literal">true</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">      type: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="string">&#x27;text&#x27;</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">onInput</span>(<span class="params">e</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.$emit(<span class="string">&#x27;input&#x27;</span>, e.target.value)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="comment">// 通知校验</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.$parent.$emit(<span class="string">&#x27;validate&#x27;</span>)</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="formItem"><a href="#formItem" class="headerlink" title="formItem"></a>formItem</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1.label --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">v-if</span>=<span class="string">&quot;label&quot;</span>&gt;</span>&#123;&#123; label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 1.5容器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2.校验错误信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-if</span>=<span class="string">&quot;error&quot;</span>&gt;</span>&#123;&#123; error &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> Validator <span class="keyword">from</span> <span class="string">&#x27;async-validator&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    inject: [<span class="string">&#x27;form&#x27;</span>],</span></span><br><span class="line">    props: &#123;</span><br><span class="line">      label: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      prop: <span class="built_in">String</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">        error: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$on(<span class="string">&#x27;validate&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.validate()</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">validate</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 单项校验</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> value = <span class="built_in">this</span>.form.model[<span class="built_in">this</span>.prop]</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> rules = <span class="built_in">this</span>.form.rules[<span class="built_in">this</span>.prop]</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> validator = <span class="keyword">new</span> Validator(&#123; [<span class="built_in">this</span>.prop]: rules &#125;)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          validator.validate(&#123; [<span class="built_in">this</span>.prop]: value &#125;, <span class="function">(<span class="params">errors</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(errors)</span></span><br><span class="line">            if (errors) &#123;</span><br><span class="line"><span class="javascript">              <span class="built_in">this</span>.error = errors[<span class="number">0</span>].message</span></span><br><span class="line">              reject()</span><br><span class="line"><span class="javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">              <span class="built_in">this</span>.error = <span class="string">&#x27;&#x27;</span></span></span><br><span class="line">              resolve()</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="form"><a href="#form" class="headerlink" title="form"></a>form</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">provide</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">        form: <span class="built_in">this</span>,</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    props: &#123;</span><br><span class="line">      model: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="javascript">        required: <span class="literal">true</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      rules: <span class="built_in">Object</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">validate</span>(<span class="params">cb</span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// 1.获取所有items，执行他们的validate，统一处理返回Promise</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> results = <span class="built_in">this</span>.$children</span></span><br><span class="line"><span class="javascript">          .filter(<span class="function">(<span class="params">item</span>) =&gt;</span> item.prop)</span></span><br><span class="line"><span class="javascript">          .map(<span class="function">(<span class="params">item</span>) =&gt;</span> item.validate())</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(results)</span></span><br><span class="line"><span class="javascript">        <span class="built_in">Promise</span>.all(results)</span></span><br><span class="line"><span class="javascript">          .then(<span class="function">() =&gt;</span> cb(<span class="literal">true</span>))</span></span><br><span class="line"><span class="javascript">          .catch(<span class="function">() =&gt;</span> cb(<span class="literal">false</span>))</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="使用-form"><a href="#使用-form" class="headerlink" title="使用 form"></a>使用 form</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Form</span> <span class="attr">:model</span>=<span class="string">&quot;model&quot;</span> <span class="attr">:rules</span>=<span class="string">&quot;rules&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;loginForm&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;用户名&quot;</span> <span class="attr">prop</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Input</span> <span class="attr">v-model</span>=<span class="string">&quot;model.username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入用户名&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Input</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;密码&quot;</span> <span class="attr">prop</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Input</span> <span class="attr">v-model</span>=<span class="string">&quot;model.password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Input</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">FormItem</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;onLogin&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> Input <span class="keyword">from</span> <span class="string">&quot;@/components/form/Input.vue&quot;</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> FormItem <span class="keyword">from</span> <span class="string">&quot;@/components/form/FormItem.vue&quot;</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> Form <span class="keyword">from</span> <span class="string">&quot;@/components/form/Form.vue&quot;</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">  components: &#123;</span><br><span class="line">    Input,</span><br><span class="line">    FormItem,</span><br><span class="line">    Form</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line">      model: &#123;</span><br><span class="line"><span class="javascript">        username: <span class="string">&quot;tom&quot;</span>,</span></span><br><span class="line"><span class="javascript">        password: <span class="string">&#x27;&#x27;</span></span></span><br><span class="line">      &#125;,</span><br><span class="line">      rules: &#123;</span><br><span class="line"><span class="javascript">        username: [&#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;用户名为必填项&quot;</span> &#125;],</span></span><br><span class="line"><span class="javascript">        password: [&#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&quot;密码为必填项&quot;</span> &#125;],</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">onLogin</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$refs.loginForm.validate(<span class="function">(<span class="params">isValidate</span>) =&gt;</span> &#123;</span></span><br><span class="line">        if (isValidate) &#123;</span><br><span class="line"><span class="javascript">          <span class="comment">// 通过</span></span></span><br><span class="line"><span class="javascript">          <span class="built_in">console</span>.log(<span class="string">&#x27;submit login&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">          alert(<span class="string">&#x27;校验失败，请重试！&#x27;</span>)</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在 input 中，这里使用的是<code>this.$parent.$emit(&#39;validate&#39;)</code>来处理的，这里不够健壮，在 ElementUI 中，使用了 dispatch 来处理的</p><p><a href="https://github.com/ElemeFE/element/blob/HEAD/src/mixins/emitter.js">https://github.com/ElemeFE/element/blob/HEAD/src/mixins/emitter.js</a></p><p><img src="/2021/05/18/Vue%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91/2.png" alt="ElementUI源码"></p><p>在 dispatch 中，是递归向上查找父组件派发的，如果用在目前的例子中，就是如下写法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.dispatch(<span class="string">&#x27;FormItem&#x27;</span>, <span class="string">&#x27;validate&#x27;</span>)</span><br></pre></td></tr></table></figure><p>源码中的使用：<a href="https://github.com/ElemeFE/element/blob/HEAD/packages/input/src/input.vue">https://github.com/ElemeFE/element/blob/HEAD/packages/input/src/input.vue</a></p><p><img src="/2021/05/18/Vue%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91/3.png" alt="ElementUI源码"></p><p>dispatch 是通过 mixin 引入的</p><p>可以在源码中看一下 created 中对 prop 的处理。formItem 创建后发现有 prop 属性需要做校验，就 dispatch 一个<code>el.form.addField</code>事件，相当于注册。如果要执行校验，就直接访问 fields<br><a href="https://github.com/ElemeFE/element/blob/HEAD/packages/form/src/form.vue">https://github.com/ElemeFE/element/blob/HEAD/packages/form/src/form.vue</a></p><h3 id="实现弹窗组件"><a href="#实现弹窗组件" class="headerlink" title="实现弹窗组件"></a>实现弹窗组件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params">Component, props</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 创建Component组件实例</span></span><br><span class="line">  <span class="keyword">const</span> Ctor = Vue.extend(Component)</span><br><span class="line">  <span class="keyword">const</span> comp = <span class="keyword">new</span> Ctor(&#123;</span><br><span class="line">    propsData: props,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 挂载</span></span><br><span class="line">  <span class="comment">// 这里需要注意，不能直接comp.$mount(document.body)，因为$mount实际上是在执行替换操作，会导致页面空白</span></span><br><span class="line">  comp.$mount()</span><br><span class="line">  <span class="comment">// 手动追加</span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(comp.$el)</span><br><span class="line">  <span class="comment">// 销毁方法</span></span><br><span class="line">  comp.remove = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(comp.$el)</span><br><span class="line">    comp.$destroy()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> comp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写个通知组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;box-content&quot;</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    props: &#123;</span><br><span class="line">      title: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">      message: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">String</span>,</span></span><br><span class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">      duration: &#123;</span><br><span class="line"><span class="javascript">        type: <span class="built_in">Number</span>,</span></span><br><span class="line"><span class="javascript">        <span class="keyword">default</span>: <span class="number">1000</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">        isShow: <span class="literal">false</span>,</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">show</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.isShow = <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">setTimeout</span>(<span class="built_in">this</span>.hide, <span class="built_in">this</span>.duration)</span></span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">hide</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.isShow = <span class="literal">false</span></span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.remove()</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>调用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> create <span class="keyword">from</span> <span class="string">&#x27;util/create&#x27;</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> Notice <span class="keyword">from</span> <span class="string">&#x27;components/Notice.vue&#x27;</span></span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> notice = create(Notice, &#123;</span></span><br><span class="line"><span class="javascript">    title: <span class="string">&#x27;标题&#x27;</span>,</span></span><br><span class="line"><span class="javascript">    message: <span class="string">&#x27;成功&#x27;</span>,</span></span><br><span class="line">    duration: 2000</span><br><span class="line">  &#125;)</span><br><span class="line">  notice.show()</span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在平常使用类似组件时，我们是这样使用的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$notice(&#123;</span><br><span class="line">  title: <span class="string">&#x27;标题&#x27;</span>,</span><br><span class="line">  message: <span class="string">&#x27;成功&#x27;</span>,</span><br><span class="line">  duration: <span class="number">2000</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>只需要在 main.js 中注册$notice 就可以了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$notice = <span class="function"><span class="keyword">function</span> (<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> notice = create(Notice, props)</span><br><span class="line">  notice.show()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>elementUI 中就是用这种方式注册</p><p><a href="https://github.com/ElemeFE/element/blob/dev/src/index.js">https://github.com/ElemeFE/element/blob/dev/src/index.js</a></p><p><img src="/2021/05/18/Vue%E7%BB%84%E4%BB%B6%E5%8C%96%E5%BC%80%E5%8F%91/1.png" alt="elementUI源码"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;组件通信常用方式&quot;&gt;&lt;a href=&quot;#组件通信常用方式&quot; class=&quot;headerlink&quot; title=&quot;组件通信常用方式&quot;&gt;&lt;/a&gt;组件通信常用方式&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;props&lt;/li&gt;
&lt;li&gt;$emit/$on&lt;/li&gt;
&lt;li&gt;event </summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="组件化" scheme="https://yongmaple.com/tags/%E7%BB%84%E4%BB%B6%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>110数字图像编码</title>
    <link href="https://yongmaple.com/2021/05/18/110%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E7%BC%96%E7%A0%81/"/>
    <id>https://yongmaple.com/2021/05/18/110%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E7%BC%96%E7%A0%81/</id>
    <published>2021-05-18T15:31:58.000Z</published>
    <updated>2021-05-21T10:30:36.998Z</updated>
    
    <content type="html"><![CDATA[<h3 id="数字-110-图像编码："><a href="#数字-110-图像编码：" class="headerlink" title="数字 110 图像编码："></a>数字 110 图像编码：</h3><p>0：铁圈<br>1：铅笔<br>2：鸭子<br>3：耳朵<br>4：红旗<br>5：手<br>6：口哨<br>7：拐杖<br>8：葫芦<br>9：勺子<br>10：棒球<br>11：筷子<br>12：婴儿<br>13：医生<br>14：钥匙<br>15：鹦鹉<br>16：杨柳<br>17：陈浩南<br>18：尾巴<br>19：药酒<br>20：耳环<br>21：阿姨<br>22：鸳鸯<br>23：耳塞<br>24：耳饰<br>25：二胡<br>26：二流<br>27：耳机<br>28：二八大杠自行车<br>29：二舅<br>30：山洞<br>31：鲨鱼<br>32：扇儿<br>33：仙丹<br>34：绅士<br>35：珊瑚<br>36：山路<br>37：山鸡<br>38：沙发<br>39：三角<br>40：司令<br>41：司仪<br>42：柿儿<br>43：石山<br>44：石狮<br>45：师傅<br>46：石榴<br>47：司机<br>48：扫把<br>49：石球<br>50：五环<br>51：狐狸<br>52：孤儿<br>53：牡丹<br>54：武士<br>55：木屋<br>56：蜗牛<br>57：武器<br>58：苦瓜<br>59：五角<br>60：榴莲<br>61：轮椅<br>62：女儿<br>63：刘三姐<br>64：律师<br>65：老虎<br>66：溜溜球<br>67：楼梯<br>68：喇叭<br>69：牛角<br>70：麒麟<br>71：蜥蜴<br>72：企鹅<br>73：鸡蛋<br>74：骑士<br>75：积木<br>76：气流<br>77：蛐蛐<br>78：青蛙<br>79：气球<br>80：百灵<br>81：白蚁<br>82：靶儿<br>83：华山<br>84：消毒液<br>85：白虎<br>86：八路<br>87：白痴<br>88：爸爸<br>89：白酒<br>90：精灵<br>91：九姨太<br>92：球儿<br>93：救生圈<br>94：教师<br>95：酒壶<br>96：旧炉<br>97：酒席<br>98：酒吧<br>99：舅舅<br>00：望远镜<br>01：羚羊<br>02：铃儿<br>03：灵山<br>04：零食<br>05：灵符<br>06：灵力<br>07：令旗<br>08：篱笆<br>09：灵柩</p><h3 id="字母数字声母对应系统"><a href="#字母数字声母对应系统" class="headerlink" title="字母数字声母对应系统"></a>字母数字声母对应系统</h3><p><img src="/2021/05/18/110%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E7%BC%96%E7%A0%81/1.png" alt="字母数字声母对应"></p><h3 id="声母对应数字的记忆："><a href="#声母对应数字的记忆：" class="headerlink" title="声母对应数字的记忆："></a>声母对应数字的记忆：</h3><p>0—D：0 象形 D。<br>1—y：1 的发音首字母是 y。<br>2—Z：象形。<br>3—S：3 的手音首字母是 S。<br>4—h：倒象形。<br>5—w：5 的手音首字母是 W。<br>6—g：倒象形。<br>7—t：象形。<br>8—b：象形。<br>9—q：象形。</p><h3 id="千位数字宫殿编码制作范例"><a href="#千位数字宫殿编码制作范例" class="headerlink" title="千位数字宫殿编码制作范例"></a>千位数字宫殿编码制作范例</h3><p>123 对应字母：yzs=椅子上=坐垫。<br>546 对应字母：whg=无花果。<br>457 对应字母：hwt 话务台=电话。<br>965 对应字母：qgw 情歌王=情歌王子张信哲。<br>786 对应字母：tbg 特别高=姚明。</p><h3 id="千位数字宫殿记忆信息范例"><a href="#千位数字宫殿记忆信息范例" class="headerlink" title="千位数字宫殿记忆信息范例"></a>千位数字宫殿记忆信息范例</h3><p>123 椅子上=坐垫。<br>124 一直挥=旗帜。<br>125 杨宗纬。<br>126 一只狗。<br>127 圆柱体。<br>128 圆珠笔。</p><h3 id="千位数字宫殿随机成语记忆"><a href="#千位数字宫殿随机成语记忆" class="headerlink" title="千位数字宫殿随机成语记忆"></a>千位数字宫殿随机成语记忆</h3><p>相亲相爱——123（yzs）椅子上=坐垫联想：坐垫上有两个人在相亲相爱。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;数字-110-图像编码：&quot;&gt;&lt;a href=&quot;#数字-110-图像编码：&quot; class=&quot;headerlink&quot; title=&quot;数字 110 图像编码：&quot;&gt;&lt;/a&gt;数字 110 图像编码：&lt;/h3&gt;&lt;p&gt;0：铁圈&lt;br&gt;1：铅笔&lt;br&gt;2：鸭子&lt;br&gt;3：耳朵&lt;b</summary>
      
    
    
    
    <category term="记忆" scheme="https://yongmaple.com/categories/%E8%AE%B0%E5%BF%86/"/>
    
    
    <category term="记忆宫殿" scheme="https://yongmaple.com/tags/%E8%AE%B0%E5%BF%86%E5%AE%AB%E6%AE%BF/"/>
    
  </entry>
  
  <entry>
    <title>Vue面试题</title>
    <link href="https://yongmaple.com/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <id>https://yongmaple.com/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/</id>
    <published>2021-04-26T15:05:30.000Z</published>
    <updated>2021-05-21T10:30:37.050Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-v-if-和-v-for-哪个优先级更高？如果两个同时出现，应该怎么优化得到更好的性能？"><a href="#1-v-if-和-v-for-哪个优先级更高？如果两个同时出现，应该怎么优化得到更好的性能？" class="headerlink" title="1. v-if 和 v-for 哪个优先级更高？如果两个同时出现，应该怎么优化得到更好的性能？"></a>1. v-if 和 v-for 哪个优先级更高？如果两个同时出现，应该怎么优化得到更好的性能？</h3><h4 id="简答："><a href="#简答：" class="headerlink" title="简答："></a>简答：</h4><ul><li>v-for 优先级更高</li><li>将 v-if 提取出来，可以用<code>&lt;template v-if=&quot;condition&quot;&gt;&lt;div v-for=&quot;item in items&quot;&gt;&lt;/div&gt;&lt;/template&gt;</code></li></ul><h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><p>一个简单的例子，打印出渲染函数</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;p v-if=&quot;isShow&quot; v-for=&quot;item in list&quot;&gt;&#123;&#123;item.name&#125;&#125;&lt;/p&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-if</span>=<span class="string">&quot;isShow&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-for</span>=<span class="string">&quot;item in list&quot;</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../../dist//vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">      el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line">          list: [</span><br><span class="line">            &#123;</span><br><span class="line"><span class="javascript">              name: <span class="string">&#x27;foo&#x27;</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line"><span class="javascript">              name: <span class="string">&#x27;bar&#x27;</span>,</span></span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line"><span class="javascript">          isShow: <span class="literal">true</span>,</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(app.$options.render)</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>此为不用 template 提取 v-if 的结果<br>其中<code>_l</code>是列表渲染函数，可以看出，在外层先执行了<code>_l</code>，再在其内部执行 isShow 的判断</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ƒ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line"><span class="function"><span class="title">with</span>(<span class="params"><span class="built_in">this</span></span>)</span>&#123;<span class="keyword">return</span> _c(<span class="string">&#x27;div&#x27;</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;demo&quot;</span>&#125;&#125;,_l((list),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;<span class="keyword">return</span> (isShow)?_c(<span class="string">&#x27;p&#x27;</span>,[_v(_s(item.name))]):_e()&#125;),<span class="number">0</span>)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此为使用 template 提取 v-if 的结果<br>外层先进行了 isShow 的判断，再执行内部的<code>_l</code>列表渲染</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ƒ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line"><span class="function"><span class="title">with</span>(<span class="params"><span class="built_in">this</span></span>)</span>&#123;<span class="keyword">return</span> _c(<span class="string">&#x27;div&#x27;</span>,&#123;<span class="attr">attrs</span>:&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;demo&quot;</span>&#125;&#125;,[(isShow)?_l((list),<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;<span class="keyword">return</span> _c(<span class="string">&#x27;p&#x27;</span>,[_v(_s(item.name))])&#125;):_e()],<span class="number">2</span>)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>源码位置：<code>src/compiler/codegen/index.js</code></p><p><img src="/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/1.png" alt="genElement"></p><p>源码中就可以很明显的看到 v-for 是在 v-if 前面的</p><p><strong>如果需要根据 item 内属性的值来做 v-if，可以使用<code>computed</code>过滤出一个删选后的 list，再执行 v-for，如此便可提升性能</strong></p><h4 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h4><ol><li>显然 v-for 优先于 v-if 被解析</li><li>如果同时出现，每次渲染都会先执行循环再判断条件，无论如何循环都不可避免，浪费了性能</li><li>要避免同时出现，则在外层嵌套<code>template</code>，在这一层进行 v-if 判断，然后内部进行 v-for</li></ol><h3 id="2-Vue-组件-data-为什么必须是个函数而-Vue-的根实例则没有此限制？"><a href="#2-Vue-组件-data-为什么必须是个函数而-Vue-的根实例则没有此限制？" class="headerlink" title="2. Vue 组件 data 为什么必须是个函数而 Vue 的根实例则没有此限制？"></a>2. Vue 组件 data 为什么必须是个函数而 Vue 的根实例则没有此限制？</h3><h4 id="简答：-1"><a href="#简答：-1" class="headerlink" title="简答："></a>简答：</h4><ul><li>为了保证在多实例的时候状态相互不干扰</li><li>根实例只会有一个，所以不担心状态污染</li></ul><h4 id="分析：-1"><a href="#分析：-1" class="headerlink" title="分析："></a>分析：</h4><p>如果组件中 data 是个对象，此时会报错</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">comp</span>&gt;</span><span class="tag">&lt;/<span class="name">comp</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../../dist//vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    Vue.component(<span class="string">&#x27;comp&#x27;</span>, &#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">      template: `<span class="tag">&lt;<span class="name">div</span> @<span class="attr">click</span>=<span class="string">&quot;counter++&quot;</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">counter</span>&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line">      data: &#123;</span><br><span class="line">        counter: 1,</span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      <span class="comment">// data() &#123;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">//   return &#123;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">//     counter: 1</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">//   &#125;</span></span></span><br><span class="line"><span class="javascript">      <span class="comment">// &#125;</span></span></span><br><span class="line">    &#125;)</span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">      el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line">      data: &#123;</span><br><span class="line"><span class="javascript">        title: <span class="string">&#x27;哈哈&#x27;</span>,</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/2.png" alt="报错"></p><p>源码位置：<code>src/core/instance/state.js</code></p><p><img src="/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/3.png" alt="initData"></p><p>源码中可以看到如果 data 是函数，则执行，并将其结果作为 data 选项的值，如果不是函数，就直接使用 data</p><p><strong>在组件中 data 使用对象，一个组件的多个实例会共用一个 data，会导致数据污染</strong></p><p>在根实例中使用则不会有问题，因为在创建根实例的时候都是通过<code>new</code>的方式创建的，在全局范围他是单例的，所以不会存在污染</p><p><code>src/core/util/options.js</code></p><p><img src="/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/4.png" alt="校验"></p><ul><li>数据初始化的时候会去检测 data 的形式，从而去执行具体的执行方式。</li><li>由于根实例在创建的时候，它会有实例，只有根实例才会有，所以它可以躲过关于 data 选项的校验。</li><li>而如果是一个普通的组件，由于它不存在实例，所以它无法躲过 if 逻辑校验</li></ul><h4 id="结论：-1"><a href="#结论：-1" class="headerlink" title="结论："></a>结论：</h4><ul><li>Vue 组件可能存在多个实例，如果使用对象形式定义 data，则会导致它们共用一个 data 对象，那么状态变更将会影响所有组件实例，这是不合理的。</li><li>采用函数形式定义，在 initData 时会将其作为工厂函数返回全新 data 对象，有效规避多实例之间状态污染问题。</li><li>而在 Vue 根实例创建过程中则不存在该限制，也是因为根实例只能有一个，不需要担心这种问题。</li></ul><h3 id="3-你知道-vue-中-key-的作用和工作原理吗？说说你对他的理解"><a href="#3-你知道-vue-中-key-的作用和工作原理吗？说说你对他的理解" class="headerlink" title="3. 你知道 vue 中 key 的作用和工作原理吗？说说你对他的理解"></a>3. 你知道 vue 中 key 的作用和工作原理吗？说说你对他的理解</h3><h4 id="分析：-2"><a href="#分析：-2" class="headerlink" title="分析："></a>分析：</h4><p>例子：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">v-for</span>=<span class="string">&quot;item in list&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../../dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">      el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">          list: [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>],</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="built_in">this</span>.list.splice(<span class="number">2</span>, <span class="number">0</span>, <span class="string">&#x27;f&#x27;</span>)</span></span><br><span class="line">        &#125;, 2000)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面的例子中，没有 key 时<code>updateChildren</code>的执行</p><p><img src="/2021/04/26/Vue%E9%9D%A2%E8%AF%95%E9%A2%98/5.png" alt="没key"></p><p>在没有 key 的情况下，会执行 3 次更新操作，一次插入操作<br>有 key 的情况下，在<code>updateChildren</code>时，只执行了一次插入操作</p><p>最直观的方式就是在<code>src/core/vdom/patch.js</code>的<code>updateChildren</code>方法内打上条件断点，看页面上元素的变化</p><p>算法在计算时，没有 key，就相当于 key 相同（都是 undefined），再判断标签、备注等（大多数情况下可以理解为标签一致就行了），此时标签一致，所以算法会认为这是同一个节点，然后再执行 patch</p><p>patch 的时候会比较新旧是否一致，如果一致不执行更新，不一致就执行更新，所以没 key 时候相当于对 f、c、d 进行了强制更新，最后再把 e 插入</p><p>关于源码中<code>updateChildren</code>的运行机制，移步<a href="https://yongmaple.com/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/">Vue2 源码解析二</a></p><h4 id="结论：-2"><a href="#结论：-2" class="headerlink" title="结论："></a>结论：</h4><ol><li>key 的作用主要是为了高效的更新虚拟 dom，其原理是 vue 在 patch 过程中通过 key 可以精准判断两个节点是否是用一个，从而避免频繁更新不同元素，使得整个 patch 过程更加高效，减少 dom 操作量，提高性能。</li><li>另外，若不设置 key 还可能在列表更新时引发一些隐蔽的 bug</li><li>vue 中使用相同标签名元素的过渡（transition）切换时，也会使用到 key 属性，其目的也是为了让 vue 可以区分它们，否则 vue 只会替代其内部属性而不会触发过渡效果</li></ol><h3 id="4-怎么理解-vue-中的-diff-算法"><a href="#4-怎么理解-vue-中的-diff-算法" class="headerlink" title="4. 怎么理解 vue 中的 diff 算法"></a>4. 怎么理解 vue 中的 diff 算法</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><ol><li>必要性： <code>src/core/instance/lifecycle.js</code>中的 mountComponent</li></ol><ul><li>组件中可能存在很多个 data 中的 key 使用</li></ul><ol start="2"><li>执行方式： <code>src/core/vdom/patch.js</code>中的 patchVnode</li></ol><ul><li>patchVnode 是 diff 发生的地方，整体策略：深度优先，同层比较</li></ul><ol start="3"><li>高效性： <code>src/core/vdom/patch.js</code>中的 updateChildren</li></ol><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><ol><li>diff 算法是虚拟 dom 技术的必然产物：通过新旧虚拟 dom 作对比（即 diff），将变化的地方更新在真实 dom 上，另外也需要 diff 高效的执行对比过程，从何降低时间复杂度 O(n)</li><li>vue 2.x 中为了降低 Watcher 粒度，每个组件只有一个 Watcher 与之对应，只有引入 diff 才能精确找到发生变化的地方</li><li>vue 中 diff 执行的时刻是组件实例执行其更新函数时，它会比对上一次渲染结果 oldVnode 和新的渲染结果 newVnode，此过程称为 patch</li><li>diff 过程整体遵循深度优先、同层比较的策略。两个节点之间比较会根据它们是否拥有子节点或者文本节点做不同操作。比较两组子节点是算法的重点，首先假设头尾节点可能相同做 4 次比对尝试，如果没有找到相同节点才按照通用方式遍历查找，查找结束再按情况处理剩下的节点。借助 key 通常可以非常精确找到相同节点，因此整个 patch 过程非常高效</li></ol><h3 id="5-对-vue-组件化的理解"><a href="#5-对-vue-组件化的理解" class="headerlink" title="5. 对 vue 组件化的理解"></a>5. 对 vue 组件化的理解</h3><h4 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h4><ol><li>组件化定义</li></ol><ul><li><code>Vue.component(&#39;comp&#39;, &#123; template: &#39;&lt;div&gt;&lt;/div&gt;&#39;&#125;)</code>全局定义。源码位置：<code>src/core/global-api/assets.js</code></li><li><code>&lt;template&gt;&lt;div&gt;&lt;/div&gt;&lt;/template&gt;</code> 单文件组件</li></ul><ol start="2"><li><p>组件化优点</p></li><li><p>组件化实现</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-v-if-和-v-for-哪个优先级更高？如果两个同时出现，应该怎么优化得到更好的性能？&quot;&gt;&lt;a href=&quot;#1-v-if-和-v-for-哪个优先级更高？如果两个同时出现，应该怎么优化得到更好的性能？&quot; class=&quot;headerlink&quot; title=&quot;</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="面试" scheme="https://yongmaple.com/tags/%E9%9D%A2%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>手写Vue二</title>
    <link href="https://yongmaple.com/2021/04/26/%E6%89%8B%E5%86%99Vue%E4%BA%8C/"/>
    <id>https://yongmaple.com/2021/04/26/%E6%89%8B%E5%86%99Vue%E4%BA%8C/</id>
    <published>2021-04-26T14:51:36.000Z</published>
    <updated>2021-05-21T10:30:37.054Z</updated>
    
    <content type="html"><![CDATA[<p>目录：</p><ul><li><a href="https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/">手写Vue</a></li><li><a href="https://yongmaple.com/2021/04/26/%E6%89%8B%E5%86%99Vue%E4%BA%8C/">手写Vue二</a></li></ul><p>本文项目地址：<a href="https://github.com/YongMaple/my-vue">https://github.com/YongMaple/my-vue</a></p><h3 id="升级改造"><a href="#升级改造" class="headerlink" title="升级改造"></a>升级改造</h3><p>目的：引入虚拟dom</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/&quot;&gt;手写Vue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="手撕源码" scheme="https://yongmaple.com/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>JS父元素hover显示子元素且移入子元素不隐藏</title>
    <link href="https://yongmaple.com/2021/04/25/JS%E7%88%B6%E5%85%83%E7%B4%A0hover%E6%98%BE%E7%A4%BA%E5%AD%90%E5%85%83%E7%B4%A0%E4%B8%94%E7%A7%BB%E5%85%A5%E5%AD%90%E5%85%83%E7%B4%A0%E4%B8%8D%E9%9A%90%E8%97%8F/"/>
    <id>https://yongmaple.com/2021/04/25/JS%E7%88%B6%E5%85%83%E7%B4%A0hover%E6%98%BE%E7%A4%BA%E5%AD%90%E5%85%83%E7%B4%A0%E4%B8%94%E7%A7%BB%E5%85%A5%E5%AD%90%E5%85%83%E7%B4%A0%E4%B8%8D%E9%9A%90%E8%97%8F/</id>
    <published>2021-04-25T15:16:40.000Z</published>
    <updated>2021-05-21T10:30:36.998Z</updated>
    
    <content type="html"><![CDATA[<p>关键方法如下：</p><span id="more"></span><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hoverTime</span><br><span class="line"><span class="keyword">const</span> handleMouseEnter = <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!props.hoverInfo) <span class="keyword">return</span></span><br><span class="line">  <span class="built_in">clearTimeout</span>(hoverTime)</span><br><span class="line">  setHoverIndex(index)</span><br><span class="line">  <span class="keyword">if</span> (props.onHoverChange) props.onHoverChange(index)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> handleMouseLeave = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!props.hoverInfo) <span class="keyword">return</span></span><br><span class="line">  hoverTime = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    setHoverIndex(-<span class="number">1</span>)</span><br><span class="line">  &#125;, <span class="number">200</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原理：</p><p>通过<code>setTimeout</code>延迟隐藏，给用户时间从父元素移动到子元素，移入元素后清空定时器</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;关键方法如下：&lt;/p&gt;</summary>
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="前端" scheme="https://yongmaple.com/tags/%E5%89%8D%E7%AB%AF/"/>
    
    <category term="React" scheme="https://yongmaple.com/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>JS一键复制</title>
    <link href="https://yongmaple.com/2021/04/25/JS%E4%B8%80%E9%94%AE%E5%A4%8D%E5%88%B6/"/>
    <id>https://yongmaple.com/2021/04/25/JS%E4%B8%80%E9%94%AE%E5%A4%8D%E5%88%B6/</id>
    <published>2021-04-25T15:13:47.000Z</published>
    <updated>2021-05-21T10:30:36.998Z</updated>
    
    <content type="html"><![CDATA[<p>一键将数据存在剪切板上</p><p>代码如下：</p><span id="more"></span><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handleCopy = <span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 清除上一次的</span></span><br><span class="line">  <span class="keyword">const</span> removeDom = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;copyInput&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (removeDom) removeDom.remove()</span><br><span class="line">  <span class="keyword">const</span> text = <span class="built_in">document</span>.createElement(<span class="string">&#x27;textarea&#x27;</span>)</span><br><span class="line">  text.id = <span class="string">&#x27;copyInput&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> str = <span class="string">`经度：<span class="subst">$&#123;obj.lon&#125;</span></span></span><br><span class="line"><span class="string">纬度：<span class="subst">$&#123;obj.lat&#125;</span></span></span><br><span class="line"><span class="string">时间段：<span class="subst">$&#123;obj.time&#125;</span>`</span></span><br><span class="line">  text.value = str</span><br><span class="line">  <span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;lbsUserListContainer&#x27;</span>)</span><br><span class="line">  container?.appendChild(text)</span><br><span class="line">  text.select()</span><br><span class="line">  <span class="built_in">document</span>.execCommand(<span class="string">&#x27;copy&#x27;</span>)</span><br><span class="line">  text.style.display = <span class="string">&#x27;none&#x27;</span></span><br><span class="line">  message.success(<span class="string">&#x27;复制成功&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><p><code>text.style.display = &#39;none&#39;;</code>隐藏需要在<code>document.execCommand(&#39;copy&#39;);</code>后，不然无法复制</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;一键将数据存在剪切板上&lt;/p&gt;
&lt;p&gt;代码如下：&lt;/p&gt;</summary>
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="前端" scheme="https://yongmaple.com/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>实用Chrome调试方法</title>
    <link href="https://yongmaple.com/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/"/>
    <id>https://yongmaple.com/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/</id>
    <published>2021-04-21T14:11:37.000Z</published>
    <updated>2021-05-21T10:30:37.054Z</updated>
    
    <content type="html"><![CDATA[<ul><li><p>调试界面中搜索指定文件 <code>cmd⌘ + o</code></p><p><img src="/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/1.png"></p></li><li><p>条件断点</p></li></ul><p>右键新建断点时选择<code>Add conditional breakpoint</code>，然后输入判断条件，就可以只在满足条件时才进入断点</p><p><img src="/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/2.png" alt="右键"><br><img src="/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/3.png" alt="判断条件"><br><img src="/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/4.png" alt="根据条件进入断点"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;ul&gt;
&lt;li&gt;&lt;p&gt;调试界面中搜索指定文件 &lt;code&gt;cmd⌘ + o&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2021/04/21/%E5%AE%9E%E7%94%A8Chrome%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/1.pn</summary>
      
    
    
    
    <category term="工具" scheme="https://yongmaple.com/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Chrome" scheme="https://yongmaple.com/tags/Chrome/"/>
    
    <category term="调试" scheme="https://yongmaple.com/tags/%E8%B0%83%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Vue2源码解析三</title>
    <link href="https://yongmaple.com/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/"/>
    <id>https://yongmaple.com/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/</id>
    <published>2021-04-21T11:22:58.000Z</published>
    <updated>2021-05-21T10:30:37.014Z</updated>
    
    <content type="html"><![CDATA[<p>目录：</p><ul><li><a href="https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Vue2 源码解析</a></li><li><a href="https://yongmaple.com/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/">Vue2 源码解析二</a></li><li><a href="https://yongmaple.com/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/">Vue2 源码解析三</a></li></ul><p>本文项目地址：<a href="https://github.com/YongMaple/vue">https://github.com/YongMaple/vue</a> 内含测试用代码<code>/examples/test/</code></p><h3 id="组件化机制"><a href="#组件化机制" class="headerlink" title="组件化机制"></a>组件化机制</h3><h4 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h4><ul><li>全局声明 <code>Vue.component()</code></li><li>局部声明 <code>components</code></li></ul><p><code>src/core/global-api/index.js</code></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/1.png" alt="动态注册"></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/2.png" alt="ASSET_TYPES"></p><p>真正注册是在<code>initAssetRegisters</code></p><p><code>src/core/global-api/assets.js</code></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/3.png" alt="initAssetRegisters"></p><h4 id="实例化、挂载"><a href="#实例化、挂载" class="headerlink" title="实例化、挂载"></a>实例化、挂载</h4><p>在控制台打印渲染函数<code>console.log(app.$options.render)</code>可以得到如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">anonymous</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">with</span>(<span class="params"><span class="built_in">this</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _c(<span class="string">&#x27;div&#x27;</span>,&#123;</span><br><span class="line">        attrs:&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;demo&quot;</span>&#125;</span><br><span class="line">      &#125;,[</span><br><span class="line">        _c(<span class="string">&#x27;h1&#x27;</span>,[_v(<span class="string">&quot;Vue组件化机制&quot;</span>)]),</span><br><span class="line">        _v(<span class="string">&quot; &quot;</span>),</span><br><span class="line">        _c(<span class="string">&#x27;comp&#x27;</span>)</span><br><span class="line">      ],<span class="number">1</span>)&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的<code>_c</code>就是之前的<code>createElement</code></p><p><code>src/core/instance/render.js</code></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/4.png" alt="_c"></p><p><code>src/core/vdom/create-element.js</code></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/5.png" alt="createElement"></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/6.png" alt="_createElement"></p><p><code>src/core/vdom/create-component.js</code></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/8.png" alt="createComponent"></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/9.png" alt="installComponentHooks"></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/10.png" alt="hooksToMerge"></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/7.png" alt="componentVNodeHooks"></p><p><code>installComponentHooks</code>之后，创建了虚拟 dom，最终返回 vnode</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据组件名称，创建虚拟dom</span></span><br><span class="line"><span class="comment">// comp =&gt; vue-component-1-comp</span></span><br><span class="line"><span class="keyword">const</span> name = Ctor.options.name || tag</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">  <span class="string">`vue-component-<span class="subst">$&#123;Ctor.cid&#125;</span><span class="subst">$&#123;name ? <span class="string">`-<span class="subst">$&#123;name&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>,</span><br><span class="line">  data,</span><br><span class="line">  <span class="literal">undefined</span>,</span><br><span class="line">  <span class="literal">undefined</span>,</span><br><span class="line">  <span class="literal">undefined</span>,</span><br><span class="line">  context,</span><br><span class="line">  &#123; Ctor, propsData, listeners, tag, children &#125;,</span><br><span class="line">  asyncFactory</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>init 何时执行？根实例执行$mount 时</p><p>流程：</p><ol><li>根实例执行$mount   <code>vm.$mount()</code></li><li><code>vm.$mount()</code> 中执行了 <code>mountComponent()</code></li><li><code>mountComponent()</code>中声明了<code>updateComponent()</code>，<code>new Watcher()</code></li><li><code>updateComponent()</code>传入<code>new Watcher()</code>并立刻调用一次</li><li><code>updateComponent()</code> 中执行 <code>render()</code> 得到整棵虚拟 dom 树</li><li><code>render()</code>之后执行 <code>_update()</code></li><li><code>_update()</code> 中执行<code>__patch__()</code>，<code>__patch__</code>是平台特有的补丁函数，用于组件更新</li></ol><p>进入到 patch</p><p><code>src/core/vdom/patch.js</code></p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/11.png" alt="patch"></p><p>patch 中使用了 createElm 递归创建 dom 树</p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/12.png" alt="createElm"></p><p>如果是一个组件，调用 createComponent</p><p><img src="/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/13.png" alt="createComponent"></p><ul><li>问：有 parent、child 父子嵌套组件，请问生命周期顺序</li><li>答：parent.created =&gt; child.created =&gt; child.mounted =&gt; parent.mounted 类似于洋葱模型，先进后出</li></ul><p><strong>全文完</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/&quot;&gt;Vue2 源码解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="手撕源码" scheme="https://yongmaple.com/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Vue2源码解析二</title>
    <link href="https://yongmaple.com/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/"/>
    <id>https://yongmaple.com/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/</id>
    <published>2021-04-15T16:00:05.000Z</published>
    <updated>2021-05-21T10:30:37.026Z</updated>
    
    <content type="html"><![CDATA[<p>目录：</p><ul><li><a href="https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Vue2 源码解析</a></li><li><a href="https://yongmaple.com/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/">Vue2 源码解析二</a></li><li><a href="https://yongmaple.com/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/">Vue2 源码解析三</a></li></ul><p>本文项目地址：<a href="https://github.com/YongMaple/vue">https://github.com/YongMaple/vue</a> 内含测试用代码<code>/examples/test/</code></p><h3 id="异步更新队列"><a href="#异步更新队列" class="headerlink" title="异步更新队列"></a>异步更新队列</h3><p>先了解一下<code>Event Loop</code></p><p>推荐阅读：</p><ul><li><a href="https://segmentfault.com/a/1190000016278115">https://segmentfault.com/a/1190000016278115</a></li><li><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/?utm_source=html5weekly">https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/?utm_source=html5weekly</a></li></ul><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/1.png" alt="Event Loop"></p><ul><li>Task Queue 宏任务队列</li><li>Microtask Queue 微任务队列</li><li>Call Stack 调用栈</li><li>浏览器端的宏任务：setTimeout、setInterval、requestAnimationFrame、I/O、UI rendering</li><li>浏览器端的微任务：Promise、Object.observe、MutationObserver</li></ul><h5 id="简单总结下浏览器下的-Event-loop-流程："><a href="#简单总结下浏览器下的-Event-loop-流程：" class="headerlink" title="简单总结下浏览器下的 Event loop 流程："></a>简单总结下浏览器下的 Event loop 流程：</h5><ol><li>先走完全局同步任务</li><li>然后走完当前所有的微任务</li><li>执行 UI rendering</li><li>走队列第一个宏任务</li><li>走完当前所有的微任务</li><li>执行 UI rendering</li><li>如此循环，如果在微任务执行期间，出现了新的微任务，直接跟在这次微任务队列的末尾（在下次宏任务之前执行）</li></ol><p>Vue 中的具体实现</p><p><strong>nextTick: Vue 尝试使用 nextTick 执行一个异步任务</strong></p><p><strong>Vue 在组件更新的时候是批量的组件更新，把 watcher 放到 queue 里面，等刷新微任务队列的时候，一起执行</strong></p><ul><li>异步：只要侦听到数据变化，Vue 将开启一个队列，并缓冲在同一事件循环中发生的所有数据变更</li><li>批量：如果同一个 watcher 被多次触发，只会被推入到队列中一次。去重对于避免不必要的计算和 DOM 操作是非常重要的。然后在下一个事件循环 Tick 中，Vue 刷新队列执行实际工作</li><li>异步策略：Vue 在内部对异步队列尝试使用原生的<code>Promise.then</code>、<code>MutationObserver</code>或<code>setImmediate</code>，如果执行环境都不支持，则会采用<code>setTimeout</code>代替</li></ul><p>响应式相关的，从<code>defineReactive</code>开始看</p><p><code>src/core/observer/index.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/2.png" alt="defineReactive"></p><p>当一个值发生变化的时候，会被拦截，然后开始设一个最新的值，设完之后让 dep 去通知更新</p><p><code>src/core/observer/dep.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/3.png" alt="notify"></p><p>subs 里存放的是和当前 key 相关的一堆 watcher</p><p><code>src/core/observer/watcher.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/4.png" alt="update"></p><p>进入 Watcher 实例</p><p>lazy 不会立即得到最新的值，而是等界面中用到相关的派生值时才会，比如计算属性</p><p>sync 设置同步，会立即执行更新，比如在用$watch 时，传入 immediate: true 时</p><p>queueWatcher 是 watcher 入队操作</p><p><code>src/core/observer/scheduler.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/5.png" alt="queueWatcher"></p><p>queueWatcher 会对 watcher 进行去重</p><p>nextTick：执行一个异步任务</p><p><code>nextTick(flushSchedulerQueue)</code>：这里就是异步执行 flushSchedulerQueue(刷新调度队列)</p><p>flushSchedulerQueue 会被放到微任务队列</p><p><code>src/core/util/next-tick.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/6.png" alt="nextTick"></p><p>这个<code>nextTick</code>方法，就是平时用的$nextTick</p><p><code>callbacks</code>是存放异步任务的数组（不是微任务队列），是将来<code>flushSchedulerQueue</code>要清空的任务的集合</p><p>对 cb 进行了一次封装之后放入<code>callbacks</code>，但并不会立即执行</p><p>通过<code>timerFunc()</code>尝试异步执行</p><p><code>timerFunc</code>是一个全局变量，根据当前平台进行判断，选择用何种方式异步执行<code>flushCallbacks</code></p><p><code>flushCallbacks</code>执行 callbacks 中的所有任务</p><p>流程：</p><ol><li>nextTick 把 flushSchedulerQueue 放入 callbacks</li><li>timerFunc() 用异步的方式执行 flushCallbacks()</li><li>flushCallbacks 执行了 flushSchedulerQueue</li><li>flushSchedulerQueue 清空存放所有 watcher 的 queue</li></ol><p>为什么要这么做？因为 callbacks 里面执行了很多组件的更新</p><p><code>src/core/observer/scheduler.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/7.png" alt="flushSchedulerQueue"></p><p>flushSchedulerQueue 对 queue 排序后遍历执行 watcher</p><p>真正执行(render watcher、 user watcher)更新操作的是<code>watcher.run()</code></p><p><code>src/core/observer/watcher.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/8.png" alt="run"></p><p>如果当前组件处于激活状态，就执行<code>get()</code></p><p>如果 watcher 是一个 render watcher,，那么<code>get()</code>就是组件更新函数</p><p>如果 watcher 是 user watcher，那么<code>get()</code>是计算当前选项最新值的函数</p><p>下面的<code>if(value !== this.value || isObject(value) || this.deep)</code>只有 user watcher（watch、$watch）才会执行</p><p><code>this.cb.call</code>是用户定义的回调函数</p><p>如果是 render watcher，只走到<code>get()</code></p><p><code>src/core/observer/watcher.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/9.png" alt="get"></p><p><code>get()</code>其实执行的是 getter，也就是组件更新函数</p><p><code>src/core/observer/watcher.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/10.png" alt="getter"></p><p><code>new Watcher(this, updateComponent)</code><br>在<code>new Watcher</code>的时候需要传递组件实例(this)，组件更新函数(updateComponent)</p><p>如果 expOrFn 是函数就直接赋值给 getter，则他就是组件更新函数</p><p>Watcher 是什么时候建的？</p><p><code>src/platforms/web/runtime/index.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/11.png" alt="Vue.prototype.$mount"></p><p>在<code>$mount</code>中执行了<code>mountComponent</code></p><p><code>src/core/instance/lifecycle.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/12.png" alt="mountComponent"></p><p>挂载的时候只做两件事</p><ol><li>声明一个组件更新函数</li><li>创建组件对应的 Watcher 实例</li></ol><p>所以 Watcher 是在组件挂载的时候创建的</p><h4 id="组件更新流程："><a href="#组件更新流程：" class="headerlink" title="组件更新流程："></a>组件更新流程：</h4><ol><li>当组件内有一个数据发生变化的时候，会通知更新</li><li>通知更新之后。组件会被放到队列</li><li>放到队列后，会把刷新队列的任务以异步的方式执行</li><li>等到未来的某个时刻刷新队列</li><li>刷新队列的时候 watcher 真正执行的函数是 run()</li><li>run()真正执行的是 getter</li><li>getter 其实就是 updateComponent</li></ol><p>当组件内数据发生变化后，未来的某个时刻，updateComponent 会重新执行以下</p><p>组件是怎么更新的？</p><ol><li>执行 render 获得虚拟 dom</li><li>vdom 需要使用<code>_update()</code>转换为真实 dom</li></ol><p><code>src/core/instance/lifecycle.js</code><br><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/13.png" alt="_update"></p><p><code>_update</code>中判断是否是初始化，初始化的话就创建 vnode 为真实 dom,追加到 vm.$el 上，不是初始化的话就 diff</p><p><code>examples/test/03-timerFunc.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>异步更新<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 创建实例</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line"><span class="javascript">      foo: <span class="string">&#x27;ready~~&#x27;</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;1:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">2</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;2:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">3</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;3:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>问： 此时 2 次 p1.innerHTML 的值是？<br>答：<code>ready~~，3</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>异步更新<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 创建实例</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line"><span class="javascript">      foo: <span class="string">&#x27;ready~~&#x27;</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;1:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">      &#125;)</span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">2</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;2:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">3</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;3:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>问： 此时 2 次 p1.innerHTML 的值是？<br>答：<code>ready~~，3</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>异步更新<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 创建实例</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line"><span class="javascript">      foo: <span class="string">&#x27;ready~~&#x27;</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">      &#125;)</span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;1:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">2</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;2:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">3</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;3:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>问： 此时 2 次 p1.innerHTML 的值是？<br>答：<code>ready~~，ready~~</code></p><p>原因：<br>$nextTick 会让 callbacks 数组中存放回调函数<br><code>this.foo = 1</code>会在 callbacks 中添加<code>flusScheduleQueue</code><br>前两种情况，foo 已经入队了，callbacks 队列类似<code>[flusScheduleQueue, nextTick.cb]</code>这样子<br>第三种情况时，foo 入队在 nextTick 后面，callbacks 中类似<code>[nextTick.cb, flusScheduleQueue]</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;demo&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>异步更新<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;p1&quot;</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 创建实例</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#demo&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line"><span class="javascript">      foo: <span class="string">&#x27;ready~~&#x27;</span>,</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="javascript">    <span class="function"><span class="title">mounted</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;1:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">2</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;2:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.foo = <span class="number">3</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;3:&#x27;</span> + <span class="built_in">this</span>.foo)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(<span class="string">&#x27;p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line"><span class="javascript">      <span class="built_in">Promise</span>.resolve().then(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;Promise p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">      &#125;)</span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;nextTick p1.innerHTML:&#x27;</span> + p1.innerHTML)</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>问：Promise 和 nextTick 谁先输出？<br>答：<code>nextTick</code></p><p>原因：<br><code>this.foo = 1</code>导致在 callbacks 中添加一个<code>flusScheduleQueue</code>，并将 callbacks 添加到微任务队列<br>Promise 执行时，将回调函数进入微任务队列<br>nextTick 执行时将回调函数进入 callbacks，此时 callbacks 类似<code>[flusScheduleQueue, nextTick.cb]</code><br>此时因为上面的微任务队列中是<code>[callbacks, Promise.then]</code>的样子<br>所以在执行 callbacks 时，会将 nextTick 一并执行后再执行 Promise.then</p><h3 id="虚拟-DOM"><a href="#虚拟-DOM" class="headerlink" title="虚拟 DOM"></a>虚拟 DOM</h3><p><strong>虚拟 DOM（Virtual DOM）是对 DOM 的 JS 抽象表示，它们是 JS 对象，能够描述 DOM 结构和关系。应用的各种状态变化会作用于虚拟 DOM，最终映射到 DOM 上。</strong></p><p>vue 中虚拟 dom 基于 <code>snabbdom</code> 实现，安装 snabbdom 并体验</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--安装并引入snabbdom--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcdn.net/ajax/libs/snabbdom/0.7.4/snabbdom.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 之前编写的响应式函数</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span></span><br><span class="line"><span class="javascript">          <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> val</span></span><br><span class="line">          &#125;,</span><br><span class="line"><span class="javascript">          <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span></span><br><span class="line">            val = newVal</span><br><span class="line"><span class="javascript">            <span class="comment">// 通知更新</span></span></span><br><span class="line">            update()</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="comment">// 导入patch的工厂init，h是产生vnode的工厂</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> &#123; init, h &#125; = snabbdom</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 获取patch函数</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> patch = init([])</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 上次vnode，由patch()返回</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> vnode</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 更新函数，将数据操作转换为dom操作，返回新vnode</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        if (!vnode) &#123;</span><br><span class="line"><span class="javascript">          <span class="comment">// 初始化，没有上次vnode，传入宿主元素和vnode</span></span></span><br><span class="line">          vnode = patch(app, render())</span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 更新，传入新旧vnode对比并做更新</span></span></span><br><span class="line">          vnode = patch(vnode, render())</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="comment">// 渲染函数，返回vnode描述dom结构</span></span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, obj.foo)</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="javascript">      <span class="comment">// 数据</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> obj = &#123;&#125;</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 定义响应式</span></span></span><br><span class="line"><span class="javascript">      defineReactive(obj, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 赋一个日期作为初始值</span></span></span><br><span class="line"><span class="javascript">      obj.foo = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()</span></span><br><span class="line"><span class="javascript">      <span class="comment">// 定时改变数据，更新函数会重新执行</span></span></span><br><span class="line"><span class="javascript">      <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        obj.foo = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()</span></span><br><span class="line">      &#125;, 1000)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="DIFF"><a href="#DIFF" class="headerlink" title="DIFF"></a>DIFF</h3><p>从<code>_update</code>看起</p><p><code>src/core/instance/lifecycle.js</code></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/14.png" alt="_update"></p><p><code>__patch__</code>从何而来？</p><p><code>src/platforms/web/runtime/index.js</code></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/15.png" alt="__patch__"></p><p><code>__patch</code>是在平台特有代码中指定的</p><p><code>src/core/vdom/patch.js</code></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/16.png" alt="createPatchFunction"></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/17.png" alt="初始化"></p><p><strong>diff 原则：深度优先，同层比较(为了降低时间复杂度)</strong></p><p>比较两个 VNode，包括三种类型操作：<em>属性更新_、_文本更新_、_子节点更新</em></p><p>具体规则如下：</p><ol><li>新老节点均有 children 子节点，则对子节点进行 diff 操作，调用 updateChildren</li><li>如果新节点有子节点而老节点没有子节点，先清空老节点的文本内容，然后为其新增子节点。</li><li>当新节点没有子节点而老节点有子节点的时候，则移除该节点的所有子节点。</li><li>当新老节点都无子节点的时候，只是文本的替换。</li></ol><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/18.png" alt="patchVnode"></p><h4 id="updateChildren-算法："><a href="#updateChildren-算法：" class="headerlink" title="updateChildren 算法："></a>updateChildren 算法：</h4><ol><li>新老 vnode 各创建一个首尾标记，向内双循环，直到<code>oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx</code></li><li>oldStartVnode 和 newStartVnodel 满足 sameVnode，就直接 patchVnode</li><li>oldStartVnode 和 newEndVnode 满足 sameVnode， patchVnode 同时将真实 dom 移到 oldEndVnode 后面</li><li>oldEndVnode 和 newStartVnode 满足 sameVnode，patchVnode 同时将真实 dom 移到 oldStartVnode 前面</li><li>如果都不满足，就在 oldVnode 中找和 newStartVnode 相同的节点，如果存在就 patchVnode 把真实 dom 添加到 oldStartIndex 前面</li><li>如果在 oldVnode 中找不到和 newStartVnode 相同的节点，就 调用 createElm，patchVnode 到 oldStartIndex 前面</li><li>如果 oldVnode 先遍历完，说明新的比老的多，就把剩下的 newVnode 插入真实 dom</li><li>如果 newVnode 先遍历完，说明老的比新的多，就把剩下的 oldVnode 对应的真实 dom 删除</li></ol><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/19.png" alt="updateChildren"></p><h4 id="key-的作用："><a href="#key-的作用：" class="headerlink" title="key 的作用："></a>key 的作用：</h4><p>先看<code>sameVnode</code>方法</p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/20.png" alt="sameVnode"></p><p>sameVnode 通过判断 tag（div、span……），注释，data，input 判断 type 等来判断是否相同</p><p>这是 isDef 方法<code>function isDef (v) &#123; return v !== undefined &amp;&amp; v !== null &#125;</code></p><p>当不设置 key 的时候，key 就是<code>undefined</code>，<code>undefined === undefined</code>，在列表操作时，就会进行强制更新</p><p>例：数组<code>[1,2,3]</code>在 2 前面添加 4<br>有 key 时，<code>[1,2,3][1,4,2,3] =&gt; [2,3][4,2,3] =&gt; [2][4,2] =&gt; [][4]</code> 最后创建 4<br>无 key 时，<code>[1,2,3][1,4,2,3] =&gt; [2,3][4,2,3] =&gt; [3][2,3] =&gt; [][3]</code> 全都强制更新一遍，最后创建 3</p><p>所以平常使用时要加 key，且 key 要保持唯一，且不要用索引，不然会导致强制更新</p><h4 id="patch-函数是怎么获取的？"><a href="#patch-函数是怎么获取的？" class="headerlink" title="patch 函数是怎么获取的？"></a>patch 函数是怎么获取的？</h4><p><code>src/platforms/web/runtime/index.js</code></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/21.png" alt="Vue.prototype.__patch__ "></p><p>传递平台特有的节点操作选项给工厂函数，返回 patch</p><p>这里 nodeOps 就是是 web 平台特有的 dom 操作</p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/22.png" alt="nodeOps"></p><p>modules 是把平台 modules 和 baseModules 做了一个拼接</p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/23.png" alt="platformModules"></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/24.png" alt="baseModules"></p><p>平台属性相关的操作会以 module 的形式暴露，都会有钩子函数的名字，最终 patch 里执行的时候调用这个钩子对应的方法</p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/25.png" alt="钩子函数"></p><h4 id="节点属性如何更新？"><a href="#节点属性如何更新？" class="headerlink" title="节点属性如何更新？"></a>节点属性如何更新？</h4><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/27.png" alt="createPatchFunction"></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/28.png" alt="patchVnode"></p><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/26.png" alt="cbs"></p><h3 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h3><p><img src="/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/29.png"></p><p><strong>本文完</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/&quot;&gt;Vue2 源码解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="手撕源码" scheme="https://yongmaple.com/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Vue2源码解析</title>
    <link href="https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</id>
    <published>2021-04-13T17:09:57.000Z</published>
    <updated>2021-05-21T10:30:37.002Z</updated>
    
    <content type="html"><![CDATA[<p>目录：</p><ul><li><a href="https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">Vue2 源码解析</a></li><li><a href="https://yongmaple.com/2021/04/15/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%BA%8C/">Vue2 源码解析二</a></li><li><a href="https://yongmaple.com/2021/04/21/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%89/">Vue2 源码解析三</a></li></ul><p>本文项目地址：<a href="https://github.com/YongMaple/vue">https://github.com/YongMaple/vue</a> 内含测试用代码<code>/examples/test/</code></p><h3 id="获取-Vue"><a href="#获取-Vue" class="headerlink" title="获取 Vue"></a>获取 Vue</h3><p>项目地址：<a href="https://github.com/vuejs/vue">https://github.com/vuejs/vue</a></p><p>当前版本号：2.6.12</p><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i</span><br><span class="line">npm i roll-up -g</span><br></pre></td></tr></table></figure><p>使用<code>npm run dev</code>就会在<code>dist</code>目录下生成编译后的<code>vue.js</code></p><h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="keyword">BACKERS.md</span></span><br><span class="line"><span class="keyword">├── </span>LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── <span class="keyword">benchmarks</span></span><br><span class="line"><span class="keyword">├── </span><span class="keyword">dist </span>         发布目录</span><br><span class="line">├── examples      范例，里面有测试代码</span><br><span class="line">├── flow          针对flow的类型声明（类似ts）</span><br><span class="line">├── package.<span class="keyword">json</span></span><br><span class="line"><span class="keyword">├── </span>packages      核心代码之外的独立库</span><br><span class="line">├── <span class="keyword">scripts </span>      构建脚本</span><br><span class="line">├── src           源码</span><br><span class="line">│   ├── compiler          编译器相关（渲染函数、SFC的编译器、dom编译器）</span><br><span class="line">│   ├── core              核心代码</span><br><span class="line">│   │   ├── components      通用组件如keep-alive</span><br><span class="line">│   │   ├── <span class="built_in">config</span>.<span class="keyword">js</span></span><br><span class="line"><span class="keyword">│ </span>  │   ├── global-api      全局API</span><br><span class="line">│   │   ├── index.<span class="keyword">js</span></span><br><span class="line"><span class="keyword">│ </span>  │   ├── <span class="keyword">instance </span>       构造函数等</span><br><span class="line">│   │   ├── observer        响应式相关</span><br><span class="line">│   │   ├── util</span><br><span class="line">│   │   └── vdom            虚拟DOM相关</span><br><span class="line">│   ├── platforms           平台</span><br><span class="line">│   │   ├── web</span><br><span class="line">│   │   └── weex            基本凉凉了</span><br><span class="line">│   ├── server</span><br><span class="line">│   ├── sfc</span><br><span class="line">│   └── <span class="keyword">shared</span></span><br><span class="line"><span class="keyword">├── </span>types         ts类型声明</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure><p>需要源码映射，所以在 package.json 中添加<code>--sourcemap</code></p><p><code>&quot;dev&quot;: &quot;rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev&quot;,</code></p><p>术语解释：</p><ul><li>runtime: 仅包含运行时，不包含编译器</li><li>common: cjs 规范，用于 webpack1</li><li>esm: ES 模块，用于 webpack2+</li><li>umd: universal module definition，兼容 cjs 和 amd，常见直接用在浏览器</li></ul><p>例：</p><ul><li><code>/dist/vue.common.js</code> 中间加 common 的，给服务端使用的，在 nodejs 环境执行的</li><li><code>/dist/vue.esm.browser.js</code> esm，给打包工具使用的，如 webpack。</li><li>browser，给支持 type=module 这种模块化方式导入的浏览器</li><li><code>/dist/vue.js</code> global，同时兼容 amd 和 cjs(commonjs)的格式。umd 的打包方式</li><li><code>/dist/vue.runtime.js</code> runtime，运行时，不含编译器，template 中加入字符串模板这类操作会报错</li></ul><h3 id="src-platforms-web-entry-runtime-with-compiler-js"><a href="#src-platforms-web-entry-runtime-with-compiler-js" class="headerlink" title="src/platforms/web/entry-runtime-with-compiler.js"></a><code>src/platforms/web/entry-runtime-with-compiler.js</code></h3><p>从 package.json <code>dev</code>中找到<code>/scripts/config.js</code></p><p><code>rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev</code>命令中传入了环境变量<code>web-full-dev</code></p><p>在<code>/scripts/config.js</code>中查找，可以在配置中找到入口文件<code>web/entry-runtime-with-compiler.js</code></p><p>文件地址前有个 resolve 方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resolve = <span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 拆分/</span></span><br><span class="line">  <span class="comment">// web/entry-runtime-with-compiler.js</span></span><br><span class="line">  <span class="keyword">const</span> base = p.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>] <span class="comment">// web</span></span><br><span class="line">  <span class="keyword">if</span> (aliases[base]) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(aliases[base], p.slice(base.length + <span class="number">1</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(__dirname, <span class="string">&#x27;../&#x27;</span>, p)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下是<code>aliases</code>的内容</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolve = <span class="function">(<span class="params">p</span>) =&gt;</span> path.resolve(__dirname, <span class="string">&#x27;../&#x27;</span>, p)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  vue: resolve(<span class="string">&#x27;src/platforms/web/entry-runtime-with-compiler&#x27;</span>),</span><br><span class="line">  compiler: resolve(<span class="string">&#x27;src/compiler&#x27;</span>),</span><br><span class="line">  core: resolve(<span class="string">&#x27;src/core&#x27;</span>),</span><br><span class="line">  shared: resolve(<span class="string">&#x27;src/shared&#x27;</span>),</span><br><span class="line">  web: resolve(<span class="string">&#x27;src/platforms/web&#x27;</span>),</span><br><span class="line">  weex: resolve(<span class="string">&#x27;src/platforms/weex&#x27;</span>),</span><br><span class="line">  server: resolve(<span class="string">&#x27;src/server&#x27;</span>),</span><br><span class="line">  sfc: resolve(<span class="string">&#x27;src/sfc&#x27;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在找到了入口文件的位置<code>src/platforms/web/entry-runtime-with-compiler.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mount = Vue.prototype.$mount</span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  ...</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span></span></span><br></pre></td></tr></table></figure><p>源码中这段是为了扩展$mount，为了解析 el、template 选项</p><p>问题 1：为什么可以不用写<code>$mount</code></p><p>答：如果设置了 el，挂载的宿主就指定为 el</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="comment">// template: &#x27;&lt;div&gt;template&lt;/div&gt;</span></span><br><span class="line">  template: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;render&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>问题 2：el、template、render 同时出现，哪个优先级高</p><p>答：render &gt; template &gt; el</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/1.png" alt="注意看注释"></p><h3 id="src-platforms-web-runtime-index-js"><a href="#src-platforms-web-runtime-index-js" class="headerlink" title="src/platforms/web/runtime/index.js"></a><code>src/platforms/web/runtime/index.js</code></h3><p>找到当前文件中的 Vue 引入<code>import Vue from &#39;./runtime/index&#39;</code></p><p>进入这个文件看一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// install platform patch function</span></span><br><span class="line"><span class="comment">// 安装平台特有的补丁函数，未来用于组件更新</span></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="comment">// 实现了$mount</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="comment">// 挂载组件：把当前组件(this)挂载到el上</span></span><br><span class="line">  <span class="comment">// 流程： mountComponent 执行this的render， 得到vnode， _update(vnode)转换成真实dom， _update内部调用的是__patch__</span></span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="built_in">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>Vue 在执行挂载时：执行渲染函数得到虚拟 dom，再执行更新函数，将其转换为真实 dom</em></p><p>继续找 Vue，当前文件的引入为<code>import Vue from &#39;core/index&#39;</code></p><p>此处 core 是<code>src/core</code>的别名</p><h3 id="src-core-index-js"><a href="#src-core-index-js" class="headerlink" title="src/core/index.js"></a><code>src/core/index.js</code></h3><p>主要做了初始化全局 API</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化全局API</span></span><br><span class="line"><span class="comment">// Vue.use directive components mixin 等</span></span><br><span class="line">initGlobalAPI(Vue)</span><br></pre></td></tr></table></figure><p>继续找 Vue，当前文件的引入为<code>import Vue from &#39;./instance/index&#39;</code></p><h3 id="src-core-instance-index-js"><a href="#src-core-instance-index-js" class="headerlink" title="src/core/instance/index.js"></a><code>src/core/instance/index.js</code></h3><p>这个文件中</p><ul><li>声明了 Vue 的构造函数</li><li>声明了 Vue 的各种实例方法($set、$watch 等等)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明Vue的构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; !(<span class="built_in">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</span><br><span class="line">    warn(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明Vue各种实例方法</span></span><br><span class="line">initMixin(Vue)</span><br><span class="line">stateMixin(Vue)</span><br><span class="line">eventsMixin(Vue)</span><br><span class="line">lifecycleMixin(Vue)</span><br><span class="line">renderMixin(Vue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure><p>这里<code>_init</code>从何而来，是在<code>initMixin()</code>中</p><h3 id="src-core-instance-init-js"><a href="#src-core-instance-init-js" class="headerlink" title="src/core/instance/init.js"></a><code>src/core/instance/init.js</code></h3><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/2.png" alt="注意注释"></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/5.png" alt="initLifecycle"></p><p>内部就是声明了各种和他有关系的组件，父、祖、子等</p><p>就是实例属性的初始化</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/3.png" alt="initEvents"></p><p>在使用自定义事件时，类似这种写法<code>&lt;Child @my-click=&quot;onClick&quot;&gt;&lt;/Child&gt;</code></p><p>回调函数（onClick）在父组件中声明的，所以用在 initEvents 中使用<code>_parentListeners</code></p><p><code>updateComponentListeners</code>是事件的监听</p><p>事件的监听和派发都是组件本身</p><p>例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">child.$emit(<span class="string">&#x27;my-click&#x27;</span>)</span><br><span class="line">child.$on(<span class="string">&#x27;my-click&#x27;</span>, listeners)</span><br></pre></td></tr></table></figure><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/4.png" alt="initRender"></p><p>在 render 中处理<code>$slots</code>和<code>$scopedSlots</code>这个比较好理解，在渲染前肯定是要把内部插槽先解析</p><p><code>$_c</code>和<code>$createElement</code>就是 render(h)中的那个 h，可以得到虚拟 dom</p><p><code>$_c</code>给编译器生成的渲染函数去使用</p><p><code>$createElement</code>给用户生成的渲染函数去使用</p><p>问：new Vue 的时候都发生了什么？</p><p>答：首先构造函数的初始化会得到一个 Vue 的实例，我们给他传入 options，我们会得到一个组件实例，在内部会做根实例的初始化</p><ol><li>初始化时会做：当前实例的关键属性初始化，例如$parent,$root,$slots,$scopeSlots 等等</li><li>同时对当前自定义组件的自定义事件的监听</li><li>派发一些生命周期钩子，beforeCreate、created</li><li>在这两个钩子中间，对组件的状态进行初始化，比如 data/props/methods/computed/watch，对他们进行数据响应式处理</li></ol><h3 id="数据响应式"><a href="#数据响应式" class="headerlink" title="数据响应式"></a>数据响应式</h3><p>可以先看下之前的这篇文章进行大致的了解</p><p><a href="https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/">https://yongmaple.com/2021/04/07/手写 Vue/</a></p><p>开始研究<code>initState</code></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/6.png" alt="initState"><br>可以看到 initState 里面，对 props、methods、data、computed、watch 进行了初始化</p><p>问：props、methods、data 中如果有重名的属性，优先谁？</p><p>答：props &gt; methods &gt; data。从上往下处理，在处理时如果发现有重名的，就会报错</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/7.png" alt="initData"></p><p>通常 data 都是 function，只有在根组件的时候可以是对象</p><p>问：为什么这里的 data 可以是对象？为什么 data 一般都是个函数，需要 return 出去，不能直接写对象？</p><ul><li>组件复用时所有组件实例都会共享 data，如果 data 是对象的话，就会造成一个组件修改 data 以后会影响到其他所有组件，所以需要将 data 写成函数，每次用到就调用一次函数获得新的数据。</li><li>当我们使用 new Vue() 的方式的时候，无论我们将 data 设置为对象还是函数都是可以的，因为 new Vue() 的方式是生成一个根组件，该组件不会复用，也就不存在共享 data 的情况了</li></ul><p>这里进入<code>observe</code>方法（<code>src/core/observer/index.js</code>）</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/8.png" alt="observe"></p><p>可以知道，在 observe 时，每个对象会创建一个 Observer</p><p>先看测试代码<code>examples/test/02-1-reactive.html</code>中的问题</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/9.png" alt="02-1-reactive.html"></p><p>再看下<code>src/core/observer/index.js</code></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/10.png" alt="Observer"></p><p>再看上面的问题，这个例子中有几个 Dep，现在就知道应该是 4 个了</p><p>每个对象创建一个 Dep，每个属性又会创建一个子 Dep，所以这里是 4 个 Dep</p><p>一个组件一个 Watcher，这个例子中只有一个 new Vue()，所以这里是 1 个 Watcher</p><p>进入 Observer 中的 this.walk</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/11.png" alt="walk"></p><p>这里 walk 遍历了对象的所有 key，进行了一个响应式的处理</p><p>进入 defineReactive</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/12.png" alt="defineReactive"></p><p>这里每个 key 都 new Dep()</p><p>还可以看到<code>let childOb = !shallow &amp;&amp; observe(val)</code></p><p>这里又对属性做了一次 observe</p><p>如果这里 childOb 存在，就说明子 Ob 内部的 dep 和当前组件的 watcher 建立了依赖关系</p><p>Dep 与 Watcher 的关系</p><ul><li>一个组件内部只有一个 Watcher</li><li>一个组件内部有多个 Dep</li><li>组件内部除了 render watcher，可能还会有 user watcher，用户会自定义($watch、watch:{})</li><li>所以他们之间是多对多的关系</li></ul><p>先看下 depend</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/13.png" alt="depend"></p><p>这里面 Dep.target 就是 WatcheraddDep</p><p>再看下 Watcher 的 addDep</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/14.png" alt="addDep"></p><p>这里面把 watcher 和 dep 相互建立了关系</p><ul><li><p>建立 Dep 与 Watcher 的关系是为了通知更新，这个很好理解</p></li><li><p>建立 Watcher 与 Dep 的关系是为了清除 watcher 时使用</p></li></ul><p>如何清除 watcher？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> unWatch = app.$watch(<span class="string">&#x27;text&#x27;</span>, <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;newVal&#125;</span> : <span class="subst">$&#123;oldVal&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 手动注销watch</span></span><br><span class="line">unWatch()</span><br></pre></td></tr></table></figure><h3 id="数组响应式"><a href="#数组响应式" class="headerlink" title="数组响应式"></a>数组响应式</h3><p>数组和对象不同，操作数组时使用 7 个方法（数组变更方法），没办法得知数据变化，vue 中采取的策略是拦截这些方法并通知 dep</p><p>先看对数组的拦截和通知 <code>src/core/observer/array.js</code></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/15.png" alt="array.js"></p><p>再找<code>arrayMethods</code>在哪使用的</p><p>Observer 中有对数组和对象分别做处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 根据Object或者Array做不同的操作</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">      <span class="comment">// 判断是否有原型</span></span><br><span class="line">      <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">        protoAugment(value, arrayMethods)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// IE等老版本浏览器</span></span><br><span class="line">        copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.observeArray(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.walk(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有原型时，直接替换掉原型</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">protoAugment</span>(<span class="params">target, src: <span class="built_in">Object</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/* eslint-disable no-proto */</span></span><br><span class="line">  <span class="comment">// 覆盖当前数组实例的原型</span></span><br><span class="line">  target.__proto__ = src</span><br><span class="line">  <span class="comment">/* eslint-enable no-proto */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没有原型时，直接把方法定义上去</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copyAugment</span>(<span class="params">target: <span class="built_in">Object</span>, src: <span class="built_in">Object</span>, keys: <span class="built_in">Array</span>&lt;string&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    def(target, key, src[key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="set，del，watch"><a href="#set，del，watch" class="headerlink" title="set，del，watch"></a>set，del，watch</h3><p>set 所在位置<code>src/core/observer/index.js</code></p><p><em>图中删了两个:any，不然颜色有问题……</em></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/17.png" alt="set"></p><p>del 就在 set 的下面，比较简单，只是删除后通知了一下</p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/18.png" alt="del"></p><p>watch 所在位置<code>src/core/instance/state.js</code></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/19.png" alt="$watch"></p><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/20.png" alt="createWatcher"></p><h3 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h3><p><img src="/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/16.png"></p><p><strong>本文完</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021/04/13/Vue2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/&quot;&gt;Vue2 源码解析&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;htt</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="手撕源码" scheme="https://yongmaple.com/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>AntV-L7中画一个指定距离的圆</title>
    <link href="https://yongmaple.com/2021/04/08/AntV-L7%E4%B8%AD%E7%94%BB%E4%B8%80%E4%B8%AA%E6%8C%87%E5%AE%9A%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%9C%86/"/>
    <id>https://yongmaple.com/2021/04/08/AntV-L7%E4%B8%AD%E7%94%BB%E4%B8%80%E4%B8%AA%E6%8C%87%E5%AE%9A%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%9C%86/</id>
    <published>2021-04-08T18:02:17.000Z</published>
    <updated>2021-05-21T10:30:36.998Z</updated>
    
    <content type="html"><![CDATA[<h3 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h3><p>先吐槽下 L7，用下来感觉就是个 KPI 项目，坑超多，文档中 N 多 404 也没人管，很多方法都没有暴露出来，只可远观，用起来就全是坑</p><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>根据经纬度和距离，在地图上显示一个圆形的范围</p><h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>一开始想用<code>PointLayer</code>的，后来发现 size 不能根据距离来生成</p><p>然后想到了绘制组件中的<code>DrawCircle</code>，去看了下源码，找到了如下这段：</p><p><code>/L7/stories/Draw/Components/DrawCircle.tsx</code></p><p><img src="/2021/04/08/AntV-L7%E4%B8%AD%E7%94%BB%E4%B8%80%E4%B8%AA%E6%8C%87%E5%AE%9A%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%9C%86/1.png"><br><img src="/2021/04/08/AntV-L7%E4%B8%AD%E7%94%BB%E4%B8%80%E4%B8%AA%E6%8C%87%E5%AE%9A%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%9C%86/2.png"></p><p>原来 L7 本身的圆就是通过多边形圆来画的，所以果断引入<code>turf</code></p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>添加依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i @turf/turf -S</span><br></pre></td></tr></table></figure><p>生成一个多边形圆</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; circle &#125; <span class="keyword">from</span> <span class="string">&#x27;@turf/turf&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> addCircleLayer = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 经纬度</span></span><br><span class="line">  <span class="keyword">const</span> center = [<span class="string">&#x27;121.138695&#x27;</span>, <span class="string">&#x27;31.246165&#x27;</span>]</span><br><span class="line">  <span class="comment">// 半径（公里）</span></span><br><span class="line">  <span class="keyword">const</span> dis = <span class="number">3</span></span><br><span class="line">  <span class="comment">// steps: 边数    边数约多约圆润</span></span><br><span class="line">  <span class="keyword">const</span> polygonCircle = circle(center, dis, &#123; <span class="attr">steps</span>: <span class="number">64</span> &#125;)</span><br><span class="line">  <span class="comment">// 生成多边形圆</span></span><br><span class="line">  <span class="keyword">const</span> circleLayer = <span class="keyword">new</span> PolygonLayer()</span><br><span class="line">    .source(&#123;</span><br><span class="line">      type: <span class="string">&#x27;FeatureCollection&#x27;</span>,</span><br><span class="line">      features: [polygonCircle],</span><br><span class="line">    &#125;)</span><br><span class="line">    .color(<span class="string">&#x27;rgba(255, 189, 72, 0.2)&#x27;</span>)</span><br><span class="line">    .shape(<span class="string">&#x27;fill&#x27;</span>)</span><br><span class="line">    .style(&#123;</span><br><span class="line">      opacity: <span class="number">0.6</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  scene?.addLayer(circleLayer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完成</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;吐槽&quot;&gt;&lt;a href=&quot;#吐槽&quot; class=&quot;headerlink&quot; title=&quot;吐槽&quot;&gt;&lt;/a&gt;吐槽&lt;/h3&gt;&lt;p&gt;先吐槽下 L7，用下来感觉就是个 KPI 项目，坑超多，文档中 N 多 404 也没人管，很多方法都没有暴露出来，只可远观，用起来就全是坑&lt;</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="AntV" scheme="https://yongmaple.com/tags/AntV/"/>
    
    <category term="L7" scheme="https://yongmaple.com/tags/L7/"/>
    
  </entry>
  
  <entry>
    <title>手写Vue</title>
    <link href="https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/"/>
    <id>https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/</id>
    <published>2021-04-07T20:31:46.000Z</published>
    <updated>2021-05-21T10:30:37.054Z</updated>
    
    <content type="html"><![CDATA[<p>目录：</p><ul><li><a href="https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/">手写Vue</a></li><li><a href="https://yongmaple.com/2021/04/26/%E6%89%8B%E5%86%99Vue%E4%BA%8C/">手写Vue二</a></li></ul><p>本文项目地址：<a href="https://github.com/YongMaple/my-vue">https://github.com/YongMaple/my-vue</a></p><h3 id="MVVM-框架的三要素：数据响应式、模板引擎及其渲染"><a href="#MVVM-框架的三要素：数据响应式、模板引擎及其渲染" class="headerlink" title="MVVM 框架的三要素：数据响应式、模板引擎及其渲染"></a>MVVM 框架的三要素：数据响应式、模板引擎及其渲染</h3><ol><li>数据响应式：监听数据变化并在视图中更新</li></ol><ul><li>Object.defineProperty()</li><li>Proxy</li></ul><ol start="2"><li>模版引擎：提供描述视图的模版语法</li></ol><ul><li><p>插值：{ { } }</p></li><li><p>指令：v-bind，v-on，v-model，v-for，v-if</p></li></ul><ol start="3"><li>渲染：如何将模板转换为 html</li></ol><ul><li>模板 =&gt; vdom =&gt; dom</li></ul><h3 id="数据响应式原理"><a href="#数据响应式原理" class="headerlink" title="数据响应式原理"></a>数据响应式原理</h3><p>数据变更能够响应在视图中，就是数据响应式。vue2 中利⽤ Object.defineProperty() 实现变更检<br>测。</p><h3 id="实现一个简单的-reactive-js"><a href="#实现一个简单的-reactive-js" class="headerlink" title="实现一个简单的 reactive.js"></a>实现一个简单的 reactive.js</h3><p><em>Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性，并返回此对象。</em></p><p>语法</p><p><em>Object.defineProperty(obj, prop, descriptor)</em></p><p>参数</p><ul><li>obj<br>要定义属性的对象。</li><li>prop<br>要定义或修改的属性的名称或 Symbol 。</li><li>descriptor<br>要定义或修改的属性描述符。</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试逻辑</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">defineReactive(obj, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">obj.foo</span><br><span class="line">obj.foo = <span class="string">&#x27;foooooooooooo&#x27;</span></span><br><span class="line">obj.foo</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">node reactive.js</span><br><span class="line">get foo:foo</span><br><span class="line"><span class="built_in">set</span> foo:foooooooooooo</span><br><span class="line">get foo:foooooooooooo</span><br></pre></td></tr></table></figure><p>放到页面中，简单写一个 update 模拟一下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>&#123;&#123;foo&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span></span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> val</span></span><br><span class="line">      &#125;,</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span></span><br><span class="line">        if (newVal !== val) &#123;</span><br><span class="line"><span class="javascript">          <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span></span><br><span class="line"><span class="javascript">          <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span></span><br><span class="line">          val = newVal</span><br><span class="line">          update()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// app:简写 相当于document.getElementById(&#x27;app&#x27;)</span></span></span><br><span class="line">    app.innerText = obj.foo</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> obj = &#123;&#125;</span></span><br><span class="line"><span class="javascript">  defineReactive(obj, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">    obj.foo = <span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()</span></span><br><span class="line">  &#125;, 1000)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>现在已经可以在页面中看到时间在变化了，但目前只能响应一个属性</p><h4 id="遍历需要响应的对象"><a href="#遍历需要响应的对象" class="headerlink" title="遍历需要响应的对象"></a>遍历需要响应的对象</h4><p>回到 reactive.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 遍历obj，动态拦截obj的所有key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    defineReactive(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>目前只是遍历了浅层的属性，还需要实现递归</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 observe 之后进行赋值的对象还不能实现响应式，需要重新递归遍历</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        <span class="comment">// 对于后赋值的对象重新递归遍历</span></span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>目前动态设置的属性还不能生效，例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.dong = <span class="string">&#x27;dong&#x27;</span></span><br></pre></td></tr></table></figure><p>此时是不生效的，模仿 Vue 进行一个封装</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  defineReactive(obj, key, val)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要设置一个新的属性时，只能使用 set 方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set(obj, <span class="string">&#x27;dong&#x27;</span>, <span class="string">&#x27;dong&#x27;</span>)</span><br></pre></td></tr></table></figure><p>用户直接使用 defineReactive，这里除了 set 写起来简单之外，set 还需要处理其他逻辑，比如数组的处理。这里暂不处理</p><h3 id="开始实现-Vue"><a href="#开始实现-Vue" class="headerlink" title="开始实现 Vue"></a>开始实现 Vue</h3><p>先写测试代码，新建一个<code>vue.html</code>，引入自己写的<code>vue.js</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123;counter&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line">      counter: 1,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="javascript">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line">    app.counter++</span><br><span class="line">  &#125;, 1000)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h4><ol><li><code>new Vue()</code> ⾸先执⾏初始化，对 data 执⾏响应化处理，这个过程发⽣在 Observer 中</li><li>同时对模板执⾏编译，找到其中动态绑定的数据，从 data 中获取并初始化视图，这个过程发⽣在<br>Compile 中</li><li>同时定义⼀个更新函数和 Watcher，将来对应数据变化时 Watcher 会调⽤更新函数</li><li>由于 data 的某个 key 在⼀个视图中可能出现多次，所以每个 key 都需要⼀个管家 Dep 来管理多个<br>Watcher</li><li>将来 data 中数据⼀旦发⽣变化，会⾸先找到对应的 Dep，通知所有 Watcher 执⾏更新函数</li></ol><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>先将之前的<code>defineReactive</code>和<code>observe</code>搬过来</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 递归遍历obj，动态拦截obj的所有key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    defineReactive(obj, key, obj[key])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="built_in">this</span>.$data = options.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对data做响应式处理</span></span><br><span class="line">    observe(<span class="built_in">this</span>.$data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个<code>Observer</code>来根据传入对象的类型做不同的相应处理</p><p>将 observe 中的 defineReactive 移到 walk 中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> || obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建Observer实例</span></span><br><span class="line">  <span class="keyword">new</span> Observer(obj)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应式对象中的某个key只要是一个对象就要创建一个Observer实例</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 核心功能：根据传入对象的类型做不同的相应处理</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> 数组处理</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对象响应式</span></span><br><span class="line">      <span class="built_in">this</span>.walk(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">walk</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      defineReactive(obj, key, obj[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里在调用 observe 时，会递归遍历。在平时 Vue 中看到的<code>__ob__</code>就是这个 Observer</p><p>现在还缺一层代理，在平时 Vue 中，可以通过<code>app.counter</code>的方式访问到属性，目前还只能通过<code>app.$data.counter</code>来访问</p><p>代理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(vm.$data).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(vm, key, &#123;</span><br><span class="line">      <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> vm.$data[key]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">        vm.$data[key] = newVal</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="built_in">this</span>.$data = options.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对data做响应式处理</span></span><br><span class="line">    observe(<span class="built_in">this</span>.$data)</span><br><span class="line">    <span class="comment">// 代理</span></span><br><span class="line">    proxy(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在就可以通过<code>app.counter</code>直接访问到了</p><h4 id="实现编译"><a href="#实现编译" class="headerlink" title="实现编译"></a>实现编译</h4><p>需要在遍历子元素的时候分别编译节点和文本</p><p>编译节点时，遍历其属性，对<code>v-</code>开头的分别处理，对<code>@</code>开头的绑定时间</p><p>编译文本时，判断是否有 <code>&#123;&#123;&#125;&#125;</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">el, vm</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$vm = vm</span><br><span class="line">    <span class="built_in">this</span>.$el = <span class="built_in">document</span>.querySelector(el)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历宿主元素</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.$el) &#123;</span><br><span class="line">      <span class="built_in">this</span>.compile(<span class="built_in">this</span>.$el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">compile</span>(<span class="params">el</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 递归遍历根元素</span></span><br><span class="line">    el.childNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isElement(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译元素&#x27;</span>, node.nodeName)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isInterpolation(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译插值文本&#x27;</span>, node.textContent)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 递归</span></span><br><span class="line">      <span class="keyword">if</span> (node.childNodes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.compile(node)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 元素判断</span></span><br><span class="line">  <span class="function"><span class="title">isElement</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 插值判断</span></span><br><span class="line">  <span class="function"><span class="title">isInterpolation</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 正则通过()分组，把&#123;&#123;&#125;&#125;中的内容放入RegExp中的$1</span></span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">3</span> &amp;&amp; <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>.test(node.textContent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vue</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="built_in">this</span>.$data = options.data</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对data做响应式处理</span></span><br><span class="line">    observe(<span class="built_in">this</span>.$data)</span><br><span class="line">    <span class="comment">// 代理</span></span><br><span class="line">    proxy(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Compile(options.el, <span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面开始解析插值文本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="title">compile</span>(<span class="params">el</span>)</span> &#123;</span><br><span class="line">    el.childNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isElement(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译元素&#x27;</span>, node.nodeName)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isInterpolation(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译插值文本&#x27;</span>, node.textContent)</span><br><span class="line">        <span class="built_in">this</span>.compileText(node)</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"> <span class="comment">// 解析插值文本</span></span><br><span class="line">  <span class="function"><span class="title">compileText</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    node.textContent = <span class="built_in">this</span>.$vm[<span class="built_in">RegExp</span>.$1]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在已经可以在页面上看到编译出来的<code>counter</code>了，不过还不会更新，因为只编译了一次，先不处理，先把编译属性处理一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="title">compile</span>(<span class="params">el</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 递归遍历根元素</span></span><br><span class="line">    el.childNodes.forEach(<span class="function">(<span class="params">node</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isElement(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译元素&#x27;</span>, node.nodeName)</span><br><span class="line">        <span class="built_in">this</span>.compileElement(node)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.isInterpolation(node)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;编译插值文本&#x27;</span>, node.textContent)</span><br><span class="line">        <span class="built_in">this</span>.compileText(node)</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 编译元素</span></span><br><span class="line">  <span class="function"><span class="title">compileElement</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历所有属性：检查是否存在指令和事件</span></span><br><span class="line">    <span class="keyword">const</span> attrs = node.attributes</span><br><span class="line">    <span class="built_in">Array</span>.from(attrs).forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr)</span><br><span class="line">      <span class="comment">// 例如：v-text=&quot;counter&quot;</span></span><br><span class="line">      <span class="comment">// attrName就是v-text</span></span><br><span class="line">      <span class="comment">// expression就是counter</span></span><br><span class="line">      <span class="keyword">const</span> attrName = attr.name</span><br><span class="line">      <span class="keyword">const</span> expression = attr.value</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只处理动态值</span></span><br><span class="line">      <span class="comment">// 指令 v-</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(attrName)) &#123;</span><br><span class="line">        <span class="comment">// 希望执行一个指令处理函数</span></span><br><span class="line">        <span class="keyword">const</span> directive = attrName.substring(<span class="number">2</span>)</span><br><span class="line">        <span class="comment">// 如果存在这个指令对应的函数就执行，比如v-text就执行text()</span></span><br><span class="line">        <span class="built_in">this</span>[directive] &amp;&amp; <span class="built_in">this</span>[directive](node, expression)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断指令</span></span><br><span class="line">  <span class="function"><span class="title">isDirective</span>(<span class="params">attrName</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> attrName.startsWith(<span class="string">&#x27;v-&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先处理一个 <code>v-text</code>，添加如下方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-text</span></span><br><span class="line"><span class="function"><span class="title">text</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  node.textContent = <span class="built_in">this</span>.$vm[expression]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在页面中添加<code>&lt;p v-text=&quot;counter&quot;&gt;&lt;/p&gt;</code>，已经可以正常显示了</p><p>再添加一个<code>v-html</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-html</span></span><br><span class="line"><span class="function"><span class="title">html</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  node.innerHTML = <span class="built_in">this</span>.$vm[expression]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>页面上添加</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-html</span>=<span class="string">&quot;desc&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line">      counter: 1,</span><br><span class="line"><span class="handlebars"><span class="xml">      desc: &#x27;foo<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color:red&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同样生效了</p><h4 id="依赖收集"><a href="#依赖收集" class="headerlink" title="依赖收集"></a>依赖收集</h4><p>给每个 key 创建一个 Dep，用来管理这个 key 的 Watcher</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> watchers = []</span><br><span class="line"><span class="comment">// 更新执行者Watcher</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">vm, key, updater</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.vm = vm</span><br><span class="line">    <span class="built_in">this</span>.key = key</span><br><span class="line">    <span class="built_in">this</span>.updater = updater</span><br><span class="line"></span><br><span class="line">    watchers.push(<span class="built_in">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updater.call(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先不做依赖收集，简单的把 watcher 放到 watchers 数组中</p><p>改造<code>Compile</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// v-text</span></span><br><span class="line">  <span class="function"><span class="title">text</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.update(node, expression, <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">textUpdater</span>(<span class="params">node, val</span>)</span> &#123;</span><br><span class="line">    node.textContent = val</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params">node, expression, directive</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 在解析指令时，不光要给它初始化，还要给它做更新函数的创建</span></span><br><span class="line">    <span class="comment">// 执行directive对应的实操函数</span></span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">this</span>[directive + <span class="string">&#x27;Updater&#x27;</span>]</span><br><span class="line">    fn &amp;&amp; fn(node, <span class="built_in">this</span>.$vm[expression])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建Watcher</span></span><br><span class="line">    <span class="keyword">new</span> Watcher(<span class="built_in">this</span>.$vm, expression, <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 形成闭包</span></span><br><span class="line">      fn &amp;&amp; fn(node, val)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造<code>defineReactive</code>，每次 set 时把 watchers 遍历</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">        <span class="comment">// update()</span></span><br><span class="line">        watchers.forEach(<span class="function">(<span class="params">w</span>) =&gt;</span> w.update())</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在<code>v-text</code>已经可以更新了</p><p>改造插值文本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析插值文本</span></span><br><span class="line"><span class="function"><span class="title">compileText</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.update(node, <span class="built_in">RegExp</span>.$1, <span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造<code>v-html</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-html</span></span><br><span class="line"><span class="function"><span class="title">html</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.update(node, expression, <span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">htmlUpdater</span>(<span class="params">node, val</span>)</span> &#123;</span><br><span class="line">  node.innerHTML = val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面是通过 watchers 是全量更新，现在创建 Dep，用来收集每个 key 的 watcher</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.deps = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">addDep</span>(<span class="params">dep</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.deps.push(dep)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">notify</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.deps.forEach(<span class="function">(<span class="params">w</span>) =&gt;</span> w.update())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改造 defineReactive 和 Watcher</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据响应式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params">obj, key, val</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 递归</span></span><br><span class="line">  observe(val)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个对应的Dep实例</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep() <span class="comment">// 这里也是闭包，dep和key是一对一的对应关系</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`get <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 依赖收集</span></span><br><span class="line">      Dep.target &amp;&amp; dep.addDep(Dep.target)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">newVal</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal !== val) &#123;</span><br><span class="line">        observe(newVal)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`set <span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;newVal&#125;</span>`</span>)</span><br><span class="line">        <span class="comment">// 函数内部有一个函数，并把值暴露出去，形成了闭包</span></span><br><span class="line">        val = newVal</span><br><span class="line">        <span class="comment">// update()</span></span><br><span class="line">        <span class="comment">// watchers.forEach((w) =&gt; w.update())</span></span><br><span class="line">        dep.notify()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">vm, key, updater</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.vm = vm</span><br><span class="line">    <span class="built_in">this</span>.key = key</span><br><span class="line">    <span class="built_in">this</span>.updater = updater</span><br><span class="line"></span><br><span class="line">    <span class="comment">// watchers.push(this)</span></span><br><span class="line">    <span class="comment">// 保存Watcher引用，放到静态变量里</span></span><br><span class="line">    Dep.target = <span class="built_in">this</span></span><br><span class="line">    <span class="comment">// 放进去立刻读取，触发defineReactive中的get</span></span><br><span class="line">    <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key]</span><br><span class="line">    Dep.target = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updater.call(<span class="built_in">this</span>.vm, <span class="built_in">this</span>.vm[<span class="built_in">this</span>.key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数组响应式"><a href="#数组响应式" class="headerlink" title="数组响应式"></a>数组响应式</h3><ol><li>找到数组原型</li><li>覆盖那些能够修改数组的更新方法，使其可以通知更新</li><li>将得到的新的原型设置到数组实例原型上</li></ol><p>先处理原型</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组响应式</span></span><br><span class="line"><span class="comment">// 1. 替换数组原型中7个方法</span></span><br><span class="line"><span class="keyword">const</span> orginalProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="comment">// 备份，修改此备份</span></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Object</span>.create(orginalProto)</span><br><span class="line"></span><br><span class="line">;[<span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;shift&#x27;</span>, <span class="string">&#x27;unshift&#x27;</span>, <span class="string">&#x27;reverse&#x27;</span>, <span class="string">&#x27;sort&#x27;</span>, <span class="string">&#x27;splice&#x27;</span>].forEach(</span><br><span class="line">  (method) =&gt; &#123;</span><br><span class="line">    arrayProto[method] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 原始操作</span></span><br><span class="line">      orginalProto[method].apply(<span class="built_in">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">      <span class="comment">// 覆盖操作：通知更新</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`数组执行：<span class="subst">$&#123;method&#125;</span>操作`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>应用新的原型</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 核心功能：根据传入对象的类型做不同的相应处理</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">      <span class="comment">// 数组处理</span></span><br><span class="line">      <span class="comment">// 覆盖原型，替换7个变更操作</span></span><br><span class="line">      obj.__proto__ = arrayProto</span><br><span class="line">      <span class="comment">// 对数组内部元素执行响应化</span></span><br><span class="line">      <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        observe(obj[i])</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对象响应式</span></span><br><span class="line">      <span class="built_in">this</span>.walk(obj)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">walk</span>(<span class="params">obj</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.keys(obj).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      defineReactive(obj, key, obj[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单测试，改下 vue.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="javascript">    el: <span class="string">&#x27;#app&#x27;</span>,</span></span><br><span class="line">    data: &#123;</span><br><span class="line">      counter: 1,</span><br><span class="line"><span class="handlebars"><span class="xml">      desc: &#x27;foo<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;color:red&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#x27;,</span></span></span><br><span class="line">      arr: [],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="javascript">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line">    app.counter++</span><br><span class="line">  &#125;, 1000)</span><br><span class="line"><span class="javascript">  app.arr.push(<span class="string">&#x27;foo&#x27;</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h3><p>和指令一样，先判断，再写一个处理函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 编译元素</span></span><br><span class="line">  <span class="function"><span class="title">compileElement</span>(<span class="params">node</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 遍历所有属性：检查是否存在指令和事件</span></span><br><span class="line">    <span class="keyword">const</span> attrs = node.attributes</span><br><span class="line">    <span class="built_in">Array</span>.from(attrs).forEach(<span class="function">(<span class="params">attr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(attr)</span><br><span class="line">      <span class="comment">// 例如：v-text=&quot;counter&quot;</span></span><br><span class="line">      <span class="comment">// attrName就是v-text</span></span><br><span class="line">      <span class="comment">// expression就是counter</span></span><br><span class="line">      <span class="keyword">const</span> attrName = attr.name</span><br><span class="line">      <span class="keyword">const</span> expression = attr.value</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 只处理动态值</span></span><br><span class="line">      <span class="comment">// 指令 v-</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isDirective(attrName)) &#123;</span><br><span class="line">        <span class="comment">// 希望执行一个指令处理函数</span></span><br><span class="line">        <span class="keyword">const</span> directive = attrName.substring(<span class="number">2</span>)</span><br><span class="line">        <span class="comment">// 如果存在这个指令对应的函数就执行，比如v-text就执行text()</span></span><br><span class="line">        <span class="built_in">this</span>[directive] &amp;&amp; <span class="built_in">this</span>[directive](node, expression)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 判断事件</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.isEvent(attrName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> event = attrName.substring(<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">this</span>.eventHandler(node, expression, event)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">eventHandler</span>(<span class="params">node, expression, event</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">this</span>.$vm.$options.methods &amp;&amp; <span class="built_in">this</span>.$vm.$options.methods[expression]</span><br><span class="line">    node.addEventListener(event, fn.bind(<span class="built_in">this</span>.$vm))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 判断事件</span></span><br><span class="line">  <span class="function"><span class="title">isEvent</span>(<span class="params">attrName</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> attrName.startsWith(<span class="string">&#x27;@&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>测试一下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-html</span>=<span class="string">&quot;desc&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;onClick&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line">    ...</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="javascript">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">&#x27;barrrrr&#x27;</span>)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="双向绑定"><a href="#双向绑定" class="headerlink" title="双向绑定"></a>双向绑定</h3><p>v-model 实际上是语法糖，解决 value 设定和事件监听</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v-model</span></span><br><span class="line"><span class="function"><span class="title">model</span>(<span class="params">node, expression</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// update方法只完成赋值和更新</span></span><br><span class="line">  <span class="built_in">this</span>.update(node, expression, <span class="string">&#x27;model&#x27;</span>)</span><br><span class="line">  <span class="comment">// 事件监听</span></span><br><span class="line">  node.addEventListener(<span class="string">&#x27;input&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 将新的值赋值给数据</span></span><br><span class="line">    <span class="built_in">this</span>.$vm[expression] = e.target.value</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">modelUpdater</span>(<span class="params">node, val</span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 给表单元素赋值</span></span><br><span class="line">  node.value = val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里只考虑了 input，其他不考虑</p><p>测试代码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;desc&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p><strong>本文完</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;目录：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021/04/07/%E6%89%8B%E5%86%99Vue/&quot;&gt;手写Vue&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://yongmaple.com/2021</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="手撕源码" scheme="https://yongmaple.com/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Vue全家桶&amp;原理</title>
    <link href="https://yongmaple.com/2021/04/01/Vue%E5%85%A8%E5%AE%B6%E6%A1%B6&amp;%E5%8E%9F%E7%90%86/"/>
    <id>https://yongmaple.com/2021/04/01/Vue%E5%85%A8%E5%AE%B6%E6%A1%B6&amp;%E5%8E%9F%E7%90%86/</id>
    <published>2021-04-01T19:47:56.000Z</published>
    <updated>2021-05-21T10:30:37.046Z</updated>
    
    <content type="html"><![CDATA[<h5 id="项目地址见本文结尾"><a href="#项目地址见本文结尾" class="headerlink" title="项目地址见本文结尾"></a><em>项目地址见本文结尾</em></h5><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>创建一个新的项目，<code>vue create vue-study</code>，选择 vue2，添加 vue-router 和 vuex，<code> vue add router</code>、<code>vue add vux </code></p><h3 id="vue-router"><a href="#vue-router" class="headerlink" title="vue-router"></a>vue-router</h3><p><em>Vue router 是 Vue.js 官方的路由管理器。它和 Vue 的核心深度集成，让构建单页面应用易如反掌</em></p><h4 id="核心步骤"><a href="#核心步骤" class="headerlink" title="核心步骤"></a>核心步骤</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/router/index.js</span></span><br><span class="line"><span class="comment">// 使用vue-router插件</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line">Vue.use(VueRouter)</span><br><span class="line"><span class="comment">// 创建Router实例</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">  routes</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="comment">// 在根组件上添加该实例</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  router,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"><span class="comment">// src/App.vue</span></span><br><span class="line"><span class="comment">// 添加路由视图</span></span><br><span class="line">&lt;router-view/&gt;</span><br><span class="line"><span class="comment">// 导航</span></span><br><span class="line">&lt;router-link to=<span class="string">&quot;/&quot;</span>&gt;Home&lt;/router-link&gt;</span><br><span class="line">&lt;router-link to=<span class="string">&quot;/about&quot;</span>&gt;About&lt;/router-link&gt;</span><br><span class="line"><span class="built_in">this</span>.$router.push(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="built_in">this</span>.$router.push(<span class="string">&#x27;/about&#x27;</span>)</span><br></pre></td></tr></table></figure><h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><ul><li>实现一个插件<ul><li>实现 VueRouter 类<ul><li>处理路由选项</li><li>监控 url 变化，hashchange</li><li>响应这个变化</li></ul></li><li>实现 install 方法<ul><li>$router注册（this.$router.push）</li><li>两个全局组件（router-link,router-view）</li></ul></li></ul></li></ul><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>为了检测后续成果，直接在<code>src/router/</code>下新建一个<code>vuerouter.js</code>，并将<code>src/router/index.js</code>中的<code>import VueRouter from &#39;vue-router&#39;</code>改为<code>import VueRouter from &#39;./vuerouter&#39;</code>。如果实现了目标，可以直接查看效果。</p><p>要实现一个 Vue 插件，要给当前类实现一个静态的<code>install</code>方法，<code>install</code>方法将来会被 vue 调用，该函数接收 Vue 构造函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">VueRouter.install = <span class="function"><span class="keyword">function</span> (<span class="params">_Vue</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VueRouter</span><br></pre></td></tr></table></figure><p>为了组件中能够使用<code>this.$router.push()</code>，需要挂载路由器实例$router</p><p>需要实现<code>Vue.prototype.$router = router</code> router 在<code>/src/router/index.js</code>的<code>const router = new VueRouter(&#123; routes &#125;)</code>中传入</p><p>但是<code>Vue.use(VueRouter)</code>时会立刻调用<code>install</code>方法，在 install 执行时 router 实例还不存在 所以需要使用<code>Vue.mixin</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Vue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// install.call(VueRouter, Vue) install调用时，如此传入_Vue</span></span><br><span class="line">VueRouter.install = <span class="function"><span class="keyword">function</span> (<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  Vue = _Vue</span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    <span class="function"><span class="title">beforeCreate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 这些代码延迟到了组件实例化的时候才执行，这时就可以获取到组件选项了</span></span><br><span class="line">      <span class="comment">// 这些代码会在所有组件中都执行，但是只有在根实例中才有router，所以只在根实例中才执行如下代码</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.$options.router) &#123;</span><br><span class="line">        Vue.prototype.$router = <span class="built_in">this</span>.$options.router</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VueRouter</span><br></pre></td></tr></table></figure><p>此时如果运行项目，会报错<code>Unknown custom element: &lt;router-link&gt;</code>和<code>Unknown custom element: &lt;router-view&gt;</code></p><h5 id="router-link"><a href="#router-link" class="headerlink" title="router-link"></a>router-link</h5><p>注册全局组件<code>router-view</code>和<code>router-link</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Vue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// install.call(VueRouter, Vue) install调用时，如此传入_Vue</span></span><br><span class="line">VueRouter.install = <span class="function"><span class="keyword">function</span>(<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  Vue = _Vue</span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  Vue.component(<span class="string">&quot;router-link&quot;</span>, &#123;&#125;)</span><br><span class="line">  Vue.component(<span class="string">&quot;router-view&quot;</span>, &#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VueRouter</span><br></pre></td></tr></table></figure><p>为组件添加<code>template</code>会报错，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&#x27;router-link&#x27;</span>, &#123;</span><br><span class="line">  template: <span class="string">&#x27;&lt;a&gt;xxxx&lt;/a&gt;&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Vue warn]: You are <span class="keyword">using</span> the runtime-<span class="keyword">only</span> build <span class="keyword">of</span> Vue <span class="keyword">where</span> the <span class="keyword">template</span> compiler <span class="keyword">is</span> <span class="keyword">not</span> available. Either pre-compile the templates <span class="keyword">into</span> render <span class="keyword">functions</span>, <span class="keyword">or</span> use the compiler-included build.</span><br></pre></td></tr></table></figure><p>当前环境是 webpack 的预打包版本，不包含编译器，所有不支持<code>template</code></p><p>改为用<code>render(h)&#123;&#125;</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&#x27;router-link&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// h是createElement，最终返回一个vdom</span></span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;router-link&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">Vue.component(<span class="string">&#x27;router-view&#x27;</span>, &#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;router-view&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>现在可以在页面上看到结果了<br><img src="/2021/04/01/Vue%E5%85%A8%E5%AE%B6%E6%A1%B6&%E5%8E%9F%E7%90%86/1.png"></p><p>使用<code>router-link</code>时，正常是这么写的<code>&lt;router-link to=&quot;/about&quot;&gt;about&lt;/router-link&gt;</code></p><p>现在需要拿到<code>about</code>来替换上面占位的<code>router-link</code></p><p>只需要使用<code>this.$slots.default</code>即可</p><p>还需要加上<code>to</code>属性，所以需要从<code>props</code>中传进来</p><p>这里实现<code>hash</code>的写法，给<code>href</code>添加<code>#</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&#x27;router-link&#x27;</span>, &#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    to: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> h(<span class="string">&#x27;a&#x27;</span>, &#123; <span class="attr">attrs</span>: &#123; <span class="attr">href</span>: <span class="string">`#<span class="subst">$&#123;<span class="built_in">this</span>.to&#125;</span>`</span> &#125; &#125;, <span class="built_in">this</span>.$slots.default)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这里也可以支持 jsx 的写法，不过不推荐，因为对当前执行环境有依赖，希望不配置 jsx 也能使用</p><p>jsx 写法如下：</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&#x27;router-link&#x27;</span>, &#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    to: &#123;</span><br><span class="line">      type: <span class="built_in">String</span>,</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#123;</span>`#$&#123;<span class="attr">this.to</span>&#125;`&#125;&gt;</span>&#123;this.$slots.default&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>🎉 router-link 完成</p><h5 id="router-view"><a href="#router-view" class="headerlink" title="router-view"></a>router-view</h5><p>现在如果直接把组件拿过来，render 出来，就可以在页面上展示出来了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">&#x27;../views/Home.vue&#x27;</span></span><br><span class="line">...</span><br><span class="line">  Vue.component(<span class="string">&quot;router-view&quot;</span>, &#123;</span><br><span class="line">    <span class="comment">// h函数可以接收的参数除了字符串，也可以是组件的配置对象</span></span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> h(Home);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>在创建实例的时候，传进来的<code>routes</code>里面包含了组件和 url 的映射关系<code>new VueRouter(&#123;routes: [...]&#125;)</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存一下，以便在router-view中拿，通过this.$router.$options拿</span></span><br><span class="line">    <span class="comment">// options就是 new VueRouter(&#123;routes: [...]&#125;) 里面传过来的</span></span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在获取当前地址<code>current</code>，去掉 hash 的#就是了。<code>window.location.hash.slice(1) || &quot;/&quot;</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.current = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>) || <span class="string">&quot;/&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">  Vue.component(<span class="string">&quot;router-view&quot;</span>, &#123;</span><br><span class="line">    <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 获取当前路由对应的组件</span></span><br><span class="line">      <span class="keyword">let</span> component = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">const</span> route = <span class="built_in">this</span>.$router.$options.routes.find(</span><br><span class="line">        (route) =&gt; route.path === <span class="built_in">this</span>.$router.current</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">if</span> (route) &#123;</span><br><span class="line">        component = route.component</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> h(component);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>现在打开页面，会发现刷新页面可以改变页面，点击路由却不会改变</p><ol><li>还没有监听的 hash 的改变</li><li>render 函数只执行一次，需要响应式</li></ol><p>监听 hash，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 监听hash变化</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;hashchange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.current = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里申明响应式属性的方式：</p><ol><li><code>new Vue(&#123;data: &#123; current: ... &#125;&#125;)</code></li><li><code>Vue.util.defineReactive</code>，这是隐藏 api</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 把current作为响应式数据</span></span><br><span class="line">    <span class="comment">// 将来发生变化，router-view的render函数能够再次执行</span></span><br><span class="line">    <span class="keyword">const</span> initial = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>) || <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    Vue.util.defineReactive(<span class="built_in">this</span>, <span class="string">&#x27;current&#x27;</span>, initial)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;hashchange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.current = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>🎉router-view 完成</p><h3 id="Vuex"><a href="#Vuex" class="headerlink" title="Vuex"></a>Vuex</h3><p><em>Vuex 集中式存储管理应用的所有组件的状态，并以相应的规则保证状态以可预测的方式发生变化</em></p><h4 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h4><ul><li>实现插件<ul><li>实现 Store 类<ul><li>维持一个响应式状态 state</li><li>实现 commit()</li><li>实现 dispatch()</li><li>getters</li></ul></li><li>挂载$store</li></ul></li></ul><h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>和 router 一样，先把<code>src/store/index.js</code>中的引用改掉<code>import Vuex from &#39;./vuex.js&#39;</code></p><p>并添加检测成果逻辑</p><p><code>/src/store/index.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;./vuex.js&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    counter: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="function"><span class="title">add</span>(<span class="params">state</span>)</span> &#123;</span><br><span class="line">      state.counter++</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="function"><span class="title">add</span>(<span class="params">&#123; commit &#125;</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        commit(<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">      &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>src/App.vue</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;nav&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span> |</span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/about&quot;</span>&gt;</span>About<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> @<span class="attr">click</span>=<span class="string">&quot;$store.commit(&#x27;add&#x27;)&quot;</span>&gt;</span>commit:&#123;&#123; $store.state.counter &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> @<span class="attr">click</span>=<span class="string">&quot;$store.dispatch(&#x27;add&#x27;)&quot;</span>&gt;</span>dispatch:&#123;&#123; $store.state.counter &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在正常使用时，使用<code>new Vuex.Store</code>的方式，所以区别于 router 如下写：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">_Vue</span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 导出的对象才是Vuex</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123; Store, install &#125;</span><br></pre></td></tr></table></figure><p>和 router 一样，挂载$store</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Vue</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  Vue = _Vue</span><br><span class="line">  <span class="comment">// 挂载$store</span></span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    <span class="function"><span class="title">beforeCreate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.$options.store) &#123;</span><br><span class="line">        Vue.prototype.$store = <span class="built_in">this</span>.$options.store</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 导出的对象才是Vuex</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123; Store, install &#125;</span><br></pre></td></tr></table></figure><p>添加响应式属性 state</p><p>在这里不能使用<code>Vue.set(this, &#39;xxx&#39;, &#123;&#125;)</code>，因为 Vue.set 是给响应式对象动态添加一个属性，这里的 this 不是一个响应式对象</p><p>router 已经用过<code>Vue.util.defineReactive</code>，这里用<code>new Vue()</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存选项</span></span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应式操作</span></span><br><span class="line">    <span class="built_in">this</span>.state = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">      data: options.state,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在直接给用户暴露了 state，用户可以直接接触到 Vue 实例，需要把 Vue 实例藏起来，让用户不能直接修改 state，而是通过 commit、dispatch 的方式修改</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存选项</span></span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应式操作</span></span><br><span class="line">    <span class="built_in">this</span>._vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">      data: &#123;</span><br><span class="line">        <span class="comment">// 加上$$，既要对state做响应式，还不做代理</span></span><br><span class="line">        $$state: options.state,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title">state</span>() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>._vm)</span><br><span class="line">    <span class="comment">// _data和$data是一回事</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._vm._data.$$state</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title">state</span>(<span class="params">v</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">&#x27;请使用replaceState重置状态&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台打印_vm</p><p><img src="/2021/04/01/Vue%E5%85%A8%E5%AE%B6%E6%A1%B6&%E5%8E%9F%E7%90%86/2.jpg"></p><p><code>__ob__</code>表示这是一个响应式对象</p><p>同时，_vm 上并没有$state，加上$之后$state 被隐藏起来了，这是 Vue 内部约定</p><p>实现 commit</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 保存mutations</span></span><br><span class="line">  <span class="built_in">this</span>._mutations = options.mutations</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// type 调用的mutation的名字 payload 参数</span></span><br><span class="line"><span class="function"><span class="title">commit</span>(<span class="params">type, payload</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> entry = <span class="built_in">this</span>._mutations[type]</span><br><span class="line">  <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">&#x27;unknown mutation&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  entry(<span class="built_in">this</span>.state, payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现 dispath</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 保存actions</span></span><br><span class="line">  <span class="built_in">this</span>._actions = options.actions</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">dispatch</span>(<span class="params">type, payload</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> entry = <span class="built_in">this</span>._actions[type]</span><br><span class="line">  <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">&#x27;unknown action&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 使用时如下： add(&#123; commit, dispatch, state, rootState ...&#125;) &#123;&#125;</span></span><br><span class="line">  <span class="comment">// 就是store实例，所以传this</span></span><br><span class="line">  entry(<span class="built_in">this</span>, payload)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在 commit 可以正常使用，dispatch 会报错</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uncaught TypeError: Cannot <span class="keyword">read</span> <span class="keyword">property</span><span class="title"> </span>&#x27;_mutations&#x27; of undefined</span><br></pre></td></tr></table></figure><p>这是因为 this 指向问题</p><p>这里锁死上下文</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 绑定commit和dispatch上下文为store实例</span></span><br><span class="line">  <span class="built_in">this</span>.commit = <span class="built_in">this</span>.commit.bind(<span class="built_in">this</span>)</span><br><span class="line">  <span class="built_in">this</span>.dispatch = <span class="built_in">this</span>.dispatch.bind(<span class="built_in">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现-getters"><a href="#实现-getters" class="headerlink" title="实现 getters"></a>实现 getters</h4><p>同样先添加检验的代码</p><p>App.vue</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;nav&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span> |</span><br><span class="line">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/about&quot;</span>&gt;</span>About<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> @<span class="attr">click</span>=<span class="string">&quot;$store.commit(&#x27;add&#x27;)&quot;</span>&gt;</span>commit:&#123;&#123; $store.state.counter &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span> @<span class="attr">click</span>=<span class="string">&quot;$store.dispatch(&#x27;add&#x27;)&quot;</span>&gt;</span>dispatch:&#123;&#123; $store.state.counter &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>doubleCounter:&#123;&#123; $store.getters.doubleCounter &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>src/store/index.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">&#x27;./vuex.js&#x27;</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    counter: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  mutations: &#123;</span><br><span class="line">    <span class="function"><span class="title">add</span>(<span class="params">state</span>)</span> &#123;</span><br><span class="line">      state.counter++</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  actions: &#123;</span><br><span class="line">    <span class="function"><span class="title">add</span>(<span class="params">&#123; commit &#125;</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        commit(<span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">      &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  modules: &#123;&#125;,</span><br><span class="line">  getters: &#123;</span><br><span class="line">    <span class="function"><span class="title">doubleCounter</span>(<span class="params">state</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> state.counter * <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>和上面一样，先保存 getters</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>._getters = options.getters</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 computed 来处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 响应式操作</span></span><br><span class="line"><span class="built_in">this</span>._vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    <span class="comment">// 加上$$，既要对state做响应式，还不做代理</span></span><br><span class="line">    $$state: options.state,</span><br><span class="line">  &#125;,</span><br><span class="line">  computed,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在 Vue 里<code>computed</code>应该是一个对象，key 是没有参数的函数</p><p>先定义一个 computed 选项，再给用户暴露一个 getters</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 定义computed选项</span></span><br><span class="line">    <span class="keyword">const</span> computed = &#123;&#125;</span><br><span class="line">    <span class="comment">// 给用户暴露getters</span></span><br><span class="line">    <span class="built_in">this</span>.getters = &#123;&#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>遍历<code>this._getters</code>执行</p><p><code>this._getters</code>是这样的结构<code>&#123;doubleCounter(state) &#123;&#125;&#125;</code>，但是需要的是无参数的函数，所以需要封装一下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 保存getters</span></span><br><span class="line">    <span class="built_in">this</span>._getters = options.getters</span><br><span class="line">    <span class="comment">// 定义computed选项</span></span><br><span class="line">    <span class="keyword">const</span> computed = &#123;&#125;</span><br><span class="line">    <span class="comment">// 给用户暴露getters</span></span><br><span class="line">    <span class="built_in">this</span>.getters = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="built_in">this</span></span><br><span class="line">    <span class="comment">// this._getters =&gt; &#123;doubleCounter(state) &#123;&#125;&#125;</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(<span class="built_in">this</span>._getters).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 获取用户定义的getter</span></span><br><span class="line">      <span class="comment">// 直接使用this._getters会有指向问题，所以定义了store</span></span><br><span class="line">      <span class="keyword">const</span> fn = store._getters[key]</span><br><span class="line">      <span class="comment">// 转换为computed可以使用的无参数形式</span></span><br><span class="line">      computed[key] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fn(store.state)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终用户访问时，只能是只读的，所以为 getters 定义只读属性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this._getters =&gt; &#123;doubleCounter(state) &#123;&#125;&#125;</span></span><br><span class="line"><span class="built_in">Object</span>.keys(<span class="built_in">this</span>._getters).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 获取用户定义的getter</span></span><br><span class="line">  <span class="keyword">const</span> fn = store._getters[key]</span><br><span class="line">  <span class="comment">// 转换为computed可以使用的无参数形式</span></span><br><span class="line">  computed[key] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fn(store.state)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 为getters定义只读属性</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(store.getters, key, &#123;</span><br><span class="line">    get: <span class="function">() =&gt;</span> store._vm[key],</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>🎉getters 完成</p><h4 id="解决路由嵌套"><a href="#解决路由嵌套" class="headerlink" title="解决路由嵌套"></a>解决路由嵌套</h4><p>还是先写个验证，<code>/src/router/index.js</code>中改写<code>about</code>，如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  path: <span class="string">&#x27;/about&#x27;</span>,</span><br><span class="line">  name: <span class="string">&#x27;About&#x27;</span>,</span><br><span class="line">  <span class="comment">// route level code-splitting</span></span><br><span class="line">  <span class="comment">// this generates a separate chunk (about.[hash].js) for this route</span></span><br><span class="line">  <span class="comment">// which is lazy-loaded when the route is visited.</span></span><br><span class="line">  component: <span class="function">() =&gt;</span></span><br><span class="line">    <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;about&quot; */</span> <span class="string">&#x27;../views/About.vue&#x27;</span>),</span><br><span class="line">  children: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">&#x27;/about/info&#x27;</span>,</span><br><span class="line">      component: &#123;</span><br><span class="line">        <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> h(<span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;info page&#x27;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>在<code>/src/views/About.vue</code>中添加<code>&lt;router-view /&gt;</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;about&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This is an about page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>先做 router-view 的深度标记</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&#x27;router-view&#x27;</span>, &#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 标记当前router-view深度</span></span><br><span class="line">    <span class="built_in">this</span>.$vnode.data.routerView = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> parent = <span class="built_in">this</span>.$parent</span><br><span class="line">    <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">      <span class="keyword">const</span> vnodeData = parent.$vnode &amp;&amp; parent.$vnode.data</span><br><span class="line">      <span class="keyword">if</span> (vnodeData) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vnodeData.routerView) &#123;</span><br><span class="line">          <span class="comment">// 说明当前parent是一个router-view</span></span><br><span class="line">          depth++</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      parent = parent.$parent</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前路由对应的组件</span></span><br><span class="line">    <span class="keyword">let</span> component = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">const</span> route = <span class="built_in">this</span>.$router.$options.routes.find(</span><br><span class="line">      (route) =&gt; route.path === <span class="built_in">this</span>.$router.current</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (route) &#123;</span><br><span class="line">      component = route.component</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h(component)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>路由匹配时获取代表深度层级的 matched 数组</p><p>改写<code>this.current</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueRouter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存一下，以便在router-view中拿，通过this.$router.$options拿</span></span><br><span class="line">    <span class="comment">// options就是 new VueRouter(&#123;routes: [...]&#125;) 里面传过来的</span></span><br><span class="line">    <span class="built_in">this</span>.$options = options</span><br><span class="line">    <span class="comment">// 把current作为响应式数据</span></span><br><span class="line">    <span class="comment">// 将来发生变化，router-view的render函数能够再次执行</span></span><br><span class="line">    <span class="comment">// const initial = window.location.hash.slice(1) || &#x27;/&#x27;</span></span><br><span class="line">    <span class="comment">// Vue.util.defineReactive(this, &#x27;current&#x27;, initial)</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.current = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>) || <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    Vue.util.defineReactive(<span class="built_in">this</span>, <span class="string">&#x27;matched&#x27;</span>, [])</span><br><span class="line">    <span class="comment">// match方法可以递归遍历路由表，获取匹配关系的数组</span></span><br><span class="line">    <span class="built_in">this</span>.match()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;hashchange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.current = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">match</span>(<span class="params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>match 是一个递归方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="title">match</span>(<span class="params">routes</span>)</span> &#123;</span><br><span class="line">  routes = routes || <span class="built_in">this</span>.$options.routes</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归遍历</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> route <span class="keyword">of</span> routes) &#123;</span><br><span class="line">    <span class="keyword">if</span> (route.path === <span class="string">&#x27;/&#x27;</span> &amp;&amp; <span class="built_in">this</span>.current === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.matched.push(route)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// /about/info</span></span><br><span class="line">    <span class="keyword">if</span> (route.path !== <span class="string">&#x27;/&#x27;</span> &amp;&amp; <span class="built_in">this</span>.current.indexOf(route.path) !== -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">this</span>.matched.push(route)</span><br><span class="line">      <span class="keyword">if</span> (route.children) &#123;</span><br><span class="line">        <span class="built_in">this</span>.match(route.children)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改获取组件的方式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Vue.component(<span class="string">&#x27;router-view&#x27;</span>, &#123;</span><br><span class="line">  <span class="function"><span class="title">render</span>(<span class="params">h</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 标记当前router-view深度</span></span><br><span class="line">    <span class="built_in">this</span>.$vnode.data.routerView = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> parent = <span class="built_in">this</span>.$parent</span><br><span class="line">    <span class="keyword">while</span> (parent) &#123;</span><br><span class="line">      <span class="keyword">const</span> vnodeData = parent.$vnode &amp;&amp; parent.$vnode.data</span><br><span class="line">      <span class="keyword">if</span> (vnodeData) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vnodeData.routerView) &#123;</span><br><span class="line">          <span class="comment">// 说明当前parent是一个router-view</span></span><br><span class="line">          depth++</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      parent = parent.$parent</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前路由对应的组件</span></span><br><span class="line">    <span class="keyword">let</span> component = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// const route = this.$options.routes.find(</span></span><br><span class="line">    <span class="comment">//   (route) =&gt; route.path === this.$router.current</span></span><br><span class="line">    <span class="comment">// )</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> route = <span class="built_in">this</span>.$router.matched[depth]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (route) &#123;</span><br><span class="line">      component = route.component</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h(component)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>当 hashchange 时，清空 matched，并重新获取</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&#x27;hashchange&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.current = <span class="built_in">window</span>.location.hash.slice(<span class="number">1</span>)</span><br><span class="line">  <span class="built_in">this</span>.matched = []</span><br><span class="line">  <span class="built_in">this</span>.match()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>🎉 完成路由嵌套</p><p><strong>全文结束</strong></p><p><em>项目地址：<a href="https://github.com/YongMaple/vue-study">https://github.com/YongMaple/vue-study</a></em></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h5 id=&quot;项目地址见本文结尾&quot;&gt;&lt;a href=&quot;#项目地址见本文结尾&quot; class=&quot;headerlink&quot; title=&quot;项目地址见本文结尾&quot;&gt;&lt;/a&gt;&lt;em&gt;项目地址见本文结尾&lt;/em&gt;&lt;/h5&gt;&lt;h3 id=&quot;准备工作&quot;&gt;&lt;a href=&quot;#准备工作&quot; class=</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
    <category term="手撕源码" scheme="https://yongmaple.com/tags/%E6%89%8B%E6%92%95%E6%BA%90%E7%A0%81/"/>
    
    <category term="vue-router" scheme="https://yongmaple.com/tags/vue-router/"/>
    
    <category term="vuex" scheme="https://yongmaple.com/tags/vuex/"/>
    
  </entry>
  
  <entry>
    <title>Vite2工程化</title>
    <link href="https://yongmaple.com/2021/03/30/Vite2%E5%B7%A5%E7%A8%8B%E5%8C%96/"/>
    <id>https://yongmaple.com/2021/03/30/Vite2%E5%B7%A5%E7%A8%8B%E5%8C%96/</id>
    <published>2021-03-30T16:18:49.000Z</published>
    <updated>2021-05-21T10:30:36.998Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Vite-是什么"><a href="#Vite-是什么" class="headerlink" title="Vite 是什么"></a>Vite 是什么</h4><p>Vite 是一个开发构建工具，开发中它利用浏览器<strong>native ES Module</strong>特性按需导入源码，预打包依赖。<br>特点：</p><ul><li>启动快</li><li>更新快</li></ul><h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init @vitejs/app</span><br></pre></td></tr></table></figure><p>这里选择 vue</p><h4 id="将资源引入为-URL"><a href="#将资源引入为-URL" class="headerlink" title="将资源引入为 URL"></a>将资源引入为 URL</h4><p>服务时引入一个静态资源会返回解析后的公共路径：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析为地址</span></span><br><span class="line"><span class="keyword">import</span> logo <span class="keyword">from</span> <span class="string">&#x27;./assets/logo.png&#x27;</span> <span class="comment">// 输出/src/assets/logo.png</span></span><br></pre></td></tr></table></figure><p>使用这个路径</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">&quot;logo&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>可以打开 Chrome Network，看 App.vue，可以看到里面的地址是被解析后的公共路径</p><p><img src="/2021/03/30/Vite2%E5%B7%A5%E7%A8%8B%E5%8C%96/1.jpg"></p><h4 id="设置别名"><a href="#设置别名" class="headerlink" title="设置别名"></a>设置别名</h4><p>vite.config.js：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineConfig(&#123;</span><br><span class="line">  ...</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: resolve(<span class="string">&#x27;./src&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;comps&#x27;</span>: resolve(<span class="string">&#x27;./src/components&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>App.vue</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">&#x27;comps/HelloWorld.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Logo <span class="keyword">from</span> <span class="string">&#x27;@/assets/logo.png&#x27;</span></span><br></pre></td></tr></table></figure><p>启动时要用<code>npm run dev</code>，使用<code>vite</code>启动控制台会报错如下：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[vite] Failed <span class="keyword">to</span> resolve <span class="built_in">module</span> <span class="keyword">import</span> <span class="string">&quot;@/assets/logo.png&quot;</span>. (imported <span class="keyword">by</span> /src/App.vue)</span><br></pre></td></tr></table></figure><p>style 中同样可以使用别名来引入图片等</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.logo</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">@/assets/logo.png</span>);</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="全局样式"><a href="#全局样式" class="headerlink" title="全局样式"></a>全局样式</h4><p>在 main.js 里引入</p><p>新建<code>/src/index.css</code>，把<code>App.vue</code>中的<code>#app &#123;&#125;</code>移入<code>index.css</code>，依然生效</p><h4 id="scoped-与-module-样式"><a href="#scoped-与-module-样式" class="headerlink" title="scoped 与 module 样式"></a>scoped 与 module 样式</h4><p>使用 scoped 时，元素会被强制加上<code>data-v-xxxx</code>，选择器的深度发生一些变化</p><p>使用 module 时，class 会 hash</p><p>两者相差不大，相对而言，module 可能更好一些</p><p>scoped 写法：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line">  .logo &#123;</span><br><span class="line"><span class="css">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">@/assets/logo.png</span>);</span></span><br><span class="line"><span class="css">    <span class="attribute">width</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="css">    <span class="attribute">height</span>: <span class="number">200px</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>module 写法：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">&quot;$style.logo&quot;</span> /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">module</span>&gt;</span></span><br><span class="line">  .logo &#123;</span><br><span class="line"><span class="css">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(<span class="string">@/assets/logo.png</span>);</span></span><br><span class="line"><span class="css">    <span class="attribute">width</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="css">    <span class="attribute">height</span>: <span class="number">200px</span>;</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/03/30/Vite2%E5%B7%A5%E7%A8%8B%E5%8C%96/2.png" alt="scoped"></p><p><img src="/2021/03/30/Vite2%E5%B7%A5%E7%A8%8B%E5%8C%96/3.png" alt="module"></p><h4 id="加载模块化-css"><a href="#加载模块化-css" class="headerlink" title="加载模块化 css"></a>加载模块化 css</h4><p>约定，在名称与 css 之间加上 module，例如：<code>App.module.css</code></p><p>新建<code>src/App.module.css</code>，将<code>.logo &#123;&#125;</code>移入，改写<code>App.vue</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;Vue logo&quot;</span> <span class="attr">:src</span>=<span class="string">&quot;Logo&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">&quot;classes.logo&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">HelloWorld</span> <span class="attr">msg</span>=<span class="string">&quot;Hello Vue 3 + Vite&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">&#x27;comps/HelloWorld.vue&#x27;</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> Logo <span class="keyword">from</span> <span class="string">&#x27;@/assets/logo.png&#x27;</span></span></span><br><span class="line"><span class="javascript">  <span class="comment">// 加载模块化css</span></span></span><br><span class="line"><span class="javascript">  <span class="keyword">import</span> classes <span class="keyword">from</span> <span class="string">&#x27;./App.module.css&#x27;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="使用-less-sass"><a href="#使用-less-sass" class="headerlink" title="使用 less/sass"></a>使用 less/sass</h4><p><code>npm i less -D</code></p><p>然后就可以直接用了，sass 同理</p><h4 id="postcss"><a href="#postcss" class="headerlink" title="postcss"></a>postcss</h4><p>只要在项目中添加<code>postcss.config.js</code>就可以了</p><p>添加需要的插件<code>npm i autoprefixer -D</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [<span class="built_in">require</span>(<span class="string">&#x27;autoprefixer&#x27;</span>)],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TS-整合"><a href="#TS-整合" class="headerlink" title="TS 整合"></a>TS 整合</h4><p>默认整合 ts，可以直接使用，<code>&lt;script lang=&quot;ts&quot;&gt;</code>即可，需要固定 ts 版本的话，在<code>package.json</code>的<code>devDependencies</code>中直接添加<code>&quot;typescript&quot;: &quot;4.1.5&quot;</code>即可</p><p>tsconfig.json 可以自行配置后放入项目即可</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;esnext&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;strict&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;jsx&quot;</span>: <span class="string">&quot;preserve&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;types&quot;</span>: [<span class="string">&quot;vite/client&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;isolatedModules&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;include&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;src/**/*.ts&quot;</span>,</span><br><span class="line">    <span class="string">&quot;src/**/*.d.ts&quot;</span>,</span><br><span class="line">    <span class="string">&quot;src/**/*.tsx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;src/**/*.vue&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tests/unit&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><p><code>vite.config.js</code>中添加如下代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineConfig(&#123;</span><br><span class="line">  ...</span><br><span class="line">  server: &#123;</span><br><span class="line">    proxy: &#123;</span><br><span class="line">      <span class="string">&quot;/api&quot;</span>: &#123;</span><br><span class="line">        target: <span class="string">&quot;***&quot;</span>,</span><br><span class="line">        changeOrigin: <span class="literal">true</span>,</span><br><span class="line">        rewrite: <span class="function">(<span class="params">path</span>) =&gt;</span> path.replace(<span class="regexp">/^\api/</span>, <span class="string">&quot;&quot;</span>),</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="数据-mock"><a href="#数据-mock" class="headerlink" title="数据 mock"></a>数据 mock</h4><p>安装依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i mockjs -S</span><br><span class="line">npm i vite-plugin-mock -D</span><br></pre></td></tr></table></figure><p>引入插件，<code>vite.config.js</code>中添加如下代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; viteMockServe &#125; <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-mock&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> defineConfig(&#123;</span><br><span class="line">  ...</span><br><span class="line">  plugins: [ viteMockServe(&#123;&#125;) ]</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>项目下创建<code>mock</code>文件夹，文件夹下就可以创建 mock 数据了，例如：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  &#123;</span><br><span class="line">    url: <span class="string">&#x27;/api/users&#x27;</span>,</span><br><span class="line">    method: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    response: <span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        code: <span class="number">0</span>,</span><br><span class="line">        data: [&#123; <span class="attr">name</span>: <span class="string">&#x27;foo&#x27;</span> &#125;, &#123; <span class="attr">name</span>: <span class="string">&#x27;bar&#x27;</span> &#125;],</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h4 id="代码规范"><a href="#代码规范" class="headerlink" title="代码规范"></a>代码规范</h4><p>使用<code>eslint + prettier</code>规范代码</p><p>添加如下依赖：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/eslint-plugin&quot;</span>: <span class="string">&quot;^4.15.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@typescript-eslint/parser&quot;</span>: <span class="string">&quot;^4.15.2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@vue/eslint-config-prettier&quot;</span>: <span class="string">&quot;^6.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@vue/eslint-config-typescript&quot;</span>: <span class="string">&quot;^7.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@vuedx/typescript-plugin-vue&quot;</span>: <span class="string">&quot;^0.6.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint&quot;</span>: <span class="string">&quot;^7.20.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint-plugin-prettier&quot;</span>: <span class="string">&quot;^3.3.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;eslint-plugin-vue&quot;</span>: <span class="string">&quot;^7.6.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;prettier&quot;</span>: <span class="string">&quot;^2.2.1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加配置文件<code>.eslintrc.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  root: <span class="literal">true</span>,</span><br><span class="line">  env: &#123;</span><br><span class="line">    browser: <span class="literal">true</span>,</span><br><span class="line">    es2021: <span class="literal">true</span>,</span><br><span class="line">    node: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">extends</span>: [</span><br><span class="line">    <span class="string">&#x27;plugin:vue/vue3-recommended&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;eslint:recommended&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@vue/typescript/recommended&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@vue/prettier&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@vue/prettier/@typescript-eslint&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">  parserOptions: &#123;</span><br><span class="line">    ecmaVersion: <span class="number">2021</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [],</span><br><span class="line">  rules: &#123;</span><br><span class="line">    <span class="string">&#x27;no-unused-vars&#x27;</span>: <span class="string">&#x27;off&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@typescript-eslint/no-unused-vars&#x27;</span>: <span class="string">&#x27;off&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>package.json 中添加如下命令</p><p><code>&quot;lint&quot;: &quot;eslint --ext .ts,vue src/** --no-error-on-unmatched-pattern&quot;</code></p><p><code>&quot;lint:fix&quot;: &quot;eslint --ext .ts,vue src/** --no-error-on-unmatched-pattern --fix&quot;</code></p><h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><p>添加依赖</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;jest&quot;</span>: <span class="string">&quot;^26.6.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@types/jest&quot;</span>: <span class="string">&quot;^26.0.20&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;vue-jest&quot;</span>: <span class="string">&quot;^5.0.0-alpha.7&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;babel-jest&quot;</span>: <span class="string">&quot;^26.6.3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@babel/preset-env&quot;</span>: <span class="string">&quot;^7.12.17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@vue/test-utils&quot;</span>: <span class="string">&quot;^2.0.0-beta.9&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ts-jest&quot;</span>: <span class="string">&quot;^26.5.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;@babel/preset-typescript&quot;</span>: <span class="string">&quot;^7.12.17&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建配置文件<code>jest.config.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  transform: &#123;</span><br><span class="line">    <span class="comment">// 用 vue-jest 处理 *.vue 文件</span></span><br><span class="line">    <span class="string">&#x27;^.+\\.vue$&#x27;</span>: <span class="string">&#x27;vue-jest&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;^.+\\.jsx?$&#x27;</span>: <span class="string">&#x27;babel-jest&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;^.+\\.tsx?$&#x27;</span>: <span class="string">&#x27;ts-jest&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// support alias</span></span><br><span class="line">  moduleNameMapper: &#123;</span><br><span class="line">    <span class="string">&#x27;^@/components(.*)$&#x27;</span>: <span class="string">&#x27;&lt;rootDir&gt;/src/components$1&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  testMatch: [<span class="string">&#x27;**/test/unit/**/*.[jt]s?(x)&#x27;</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tsconfig.json</code>中需要加上</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;types&quot;</span>: [<span class="string">&quot;vite/client&quot;</span>, <span class="string">&quot;jest&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>package.json 中添加单测命令</p><p><code>&quot;test:unit&quot;: &quot;jest&quot;</code></p><p>例子：</p><p><code>/test/unit/example.spec.ts</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> HelloWorld <span class="keyword">from</span> <span class="string">&#x27;@/components/HelloWorld.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; shallowMount &#125; <span class="keyword">from</span> <span class="string">&#x27;@vue/test-utils&#x27;</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">&#x27;aaa&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  test(<span class="string">&#x27;should&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallowMount(HelloWorld, &#123;</span><br><span class="line">      props: &#123;</span><br><span class="line">        msg: <span class="string">&#x27;hello,vue3&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    expect(wrapper.test()).toMatch(<span class="string">&#x27;hello,vue3&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>添加<code>babel.condig.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    [<span class="string">&#x27;@babel/preset-env&#x27;</span>, &#123; <span class="attr">targets</span>: &#123; <span class="attr">node</span>: <span class="string">&#x27;current&#x27;</span> &#125; &#125;],</span><br><span class="line">    <span class="string">&#x27;@babel/preset-typescript&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 git 提交时 lint 和单测</p><p>添加依赖<code>npm i lint-staged yorkie -D</code></p><p>package.json 添加配置</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;gitHooks&quot;: &#123;</span><br><span class="line">  &quot;pre-commit&quot;: &quot;lint-staged&quot;,</span><br><span class="line">  &quot;pre-push&quot;: &quot;npm run test:unit&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;lint-staged&quot;: &#123;</span><br><span class="line">  &quot;*.&#123;js,vue&#125;&quot;: &quot;eslint --fix&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>全文完</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;Vite-是什么&quot;&gt;&lt;a href=&quot;#Vite-是什么&quot; class=&quot;headerlink&quot; title=&quot;Vite 是什么&quot;&gt;&lt;/a&gt;Vite 是什么&lt;/h4&gt;&lt;p&gt;Vite 是一个开发构建工具，开发中它利用浏览器&lt;strong&gt;native ES Modu</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="Vite" scheme="https://yongmaple.com/tags/Vite/"/>
    
  </entry>
  
  <entry>
    <title>React中的nextTick</title>
    <link href="https://yongmaple.com/2021/03/29/React%E4%B8%AD%E7%9A%84nextTick/"/>
    <id>https://yongmaple.com/2021/03/29/React%E4%B8%AD%E7%9A%84nextTick/</id>
    <published>2021-03-29T15:57:09.000Z</published>
    <updated>2021-05-21T10:30:36.998Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在项目开发中，使用 AntV-L7 的 Draw-Control，需要实现在弹框中地图画圈框选范围。<br>使用了 hooks 的写法，在弹框出现后地图正常显示，点击画圈或其他绘图功能后，绘图的 canvas 只有约一半大小。<br>思考后认为应该是在<code>new DrawControl()</code>时，useState 还没执行赋值，错误范例如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handleDrawCircle = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  setShowModal(<span class="literal">true</span>)</span><br><span class="line">  scene = <span class="keyword">new</span> Scene(&#123;</span><br><span class="line">    id: <span class="string">&#x27;drawCircleWrap&#x27;</span>,</span><br><span class="line">    map: <span class="keyword">new</span> GaodeMap(&#123;</span><br><span class="line">      style: <span class="string">&#x27;dark&#x27;</span>,</span><br><span class="line">      center: [<span class="number">120.190494</span>, <span class="number">30.189643</span>],</span><br><span class="line">      pitch: <span class="number">0</span>,</span><br><span class="line">      zoom: <span class="number">4</span>,</span><br><span class="line">      token: GAODE_TOKEN,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;)</span><br><span class="line">  scene.on(<span class="string">&#x27;loaded&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    drawControl = <span class="keyword">new</span> DrawControl(scene, &#123;</span><br><span class="line">      position: <span class="string">&#x27;topright&#x27;</span>,</span><br><span class="line">      layout: <span class="string">&#x27;horizontal&#x27;</span>,</span><br><span class="line">      controls: &#123;</span><br><span class="line">        point: <span class="literal">false</span>,</span><br><span class="line">        line: <span class="literal">false</span>,</span><br><span class="line">        polygon: <span class="literal">false</span>,</span><br><span class="line">        circle: <span class="literal">true</span>,</span><br><span class="line">        rect: <span class="literal">false</span>,</span><br><span class="line">        <span class="keyword">delete</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    scene.addControl(drawControl)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按照以前写Vue的经验，只要用nextTick就能解决了，但是搜了一下，React中没有nextTick，但是有两种替代方式</p><ol><li><code>setTimeout(() =&gt; &#123;&#125;, 0)</code></li><li><code>useEffect(() =&gt; &#123;&#125;, [showModal])</code><br>两种方式在我看来都不是很好看……最后还是决定用<code>setTimeout</code>，因为用<code>useEffect</code>还需要判断下showModal是否为true</li></ol><p>如果用Class的写法，也可以这样<code>setState(&#123;&#125;,() =&gt; &#123;&#125;)</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;在项目开发中，使用 AntV-L7 的 Draw-Control，需要实现在弹框中地图画圈框选范围。&lt;br&gt;使用了 hooks 的写法，在弹</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="AntV" scheme="https://yongmaple.com/tags/AntV/"/>
    
    <category term="React" scheme="https://yongmaple.com/tags/React/"/>
    
    <category term="nextTick" scheme="https://yongmaple.com/tags/nextTick/"/>
    
    <category term="hooks" scheme="https://yongmaple.com/tags/hooks/"/>
    
  </entry>
  
  <entry>
    <title>Vue和React设计思路</title>
    <link href="https://yongmaple.com/2021/03/29/Vue%E5%92%8CReact%E6%AF%94%E8%BE%83/"/>
    <id>https://yongmaple.com/2021/03/29/Vue%E5%92%8CReact%E6%AF%94%E8%BE%83/</id>
    <published>2021-03-29T07:44:09.000Z</published>
    <updated>2021-05-21T10:30:37.046Z</updated>
    
    <content type="html"><![CDATA[<h4 id="发展历程"><a href="#发展历程" class="headerlink" title="发展历程"></a>发展历程</h4><ul><li>Vue1<br>只有响应式，没有vdom，所有的都是通知的机制</li><li>React15<br>Class Component</li><li>Vue2<br>引入了vdom</li><li>React16<br>引入了Fiber和Hooks</li><li>Vue3 &amp; React17</li></ul><h4 id="Vue3-amp-React17"><a href="#Vue3-amp-React17" class="headerlink" title="Vue3 &amp; React17"></a>Vue3 &amp; React17</h4><ul><li>Vue OptionApi<ol><li>优点：结构清晰，好理解，数据去data，方法去methods等，易学。</li><li>缺点：就是反复横跳，在处理一个逻辑时，需要在template、data、methods等反复操作。mixins有个问题，可能命名冲突，同时mixins时this是个黑盒，里面有什么是不知道的，ts支持差</li></ol></li><li>Vue CompositionApi<ol><li>缺点：难看，不如Option简单。return很蛋疼，return也要反复横跳</li><li>优点：</li></ol><ul><li>可以做tree-shaking，比如没有用到computed，代码build的时候就会删掉Vue3里面的computed的代码</li><li>组件可以任意拆分 方便组合 逻辑都是函数，组合优于继承</li><li>命名冲突了只要:起个别名就行了</li></ul></li><li>渐进式更新ref api<ul><li>setup写在script，解决return等冗余</li><li>方言：<code>let x = ref(0)</code> =&gt; <code>ref: x = 1</code>使用时可以不用写<code>x.value</code></li></ul></li><li>composition和hooks的区别<ul><li>语法上比较像，但底层设计上区别很大</li><li>hooks中例如useState每次render都会执行，所以有严格的顺序要求，不能写在if里面</li><li>composition后续靠的是响应式通知</li><li>都采用组合的形式，函数式的组件是未来</li></ul></li><li>vue 响应式 + vdom<ul><li>响应式： 数据变了通知你</li><li>vdom： 数据变了你不知道哪里变了，需要算一次diff，才知道变化</li><li>vue1只有响应式，项目大了之后，响应式对象太多，导致卡顿</li></ul></li><li>react纯vdom<ul><li>vdom树太大，diff时间超过16.6ms，会导致卡顿</li></ul></li><li>React Class =&gt; hooks</li></ul><h4 id="JSX-和-Template"><a href="#JSX-和-Template" class="headerlink" title="JSX 和 Template"></a>JSX 和 Template</h4><p>未完待续</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h4 id=&quot;发展历程&quot;&gt;&lt;a href=&quot;#发展历程&quot; class=&quot;headerlink&quot; title=&quot;发展历程&quot;&gt;&lt;/a&gt;发展历程&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;Vue1&lt;br&gt;只有响应式，没有vdom，所有的都是通知的机制&lt;/li&gt;
&lt;li&gt;React15&lt;br&gt;Clas</summary>
      
    
    
    
    <category term="前端" scheme="https://yongmaple.com/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
    <category term="React" scheme="https://yongmaple.com/tags/React/"/>
    
    <category term="Vue" scheme="https://yongmaple.com/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>设置iTerm2免密登陆ssh远程服务器</title>
    <link href="https://yongmaple.com/2021/03/27/%E8%AE%BE%E7%BD%AEiTerm2%E5%85%8D%E5%AF%86%E7%99%BB%E9%99%86ssh%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>https://yongmaple.com/2021/03/27/%E8%AE%BE%E7%BD%AEiTerm2%E5%85%8D%E5%AF%86%E7%99%BB%E9%99%86ssh%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8/</id>
    <published>2021-03-27T15:51:52.000Z</published>
    <updated>2021-05-21T10:30:37.054Z</updated>
    
    <content type="html"><![CDATA[<p>转载自<a href="https://zhuanlan.zhihu.com/p/180500618">https://zhuanlan.zhihu.com/p/180500618</a></p><p>原文中代码存在bug，已修改，如下：</p><span id="more"></span><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect -f</span></span><br><span class="line"><span class="comment">#trap sigwinch spawned</span></span><br><span class="line">  <span class="built_in">trap</span> &#123;</span><br><span class="line">    <span class="built_in">set</span> rows [stty rows]</span><br><span class="line">    <span class="built_in">set</span> cols [stty columns]</span><br><span class="line">    stty rows <span class="variable">$rows</span> columns <span class="variable">$cols</span> &lt; <span class="variable">$spawn_out</span>(slave,name)</span><br><span class="line">   &#125; WINCH</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> user username</span><br><span class="line"><span class="built_in">set</span> host 0.0.0.0</span><br><span class="line"><span class="built_in">set</span> password keys</span><br><span class="line"><span class="built_in">set</span> timeout -1</span><br><span class="line">spawn ssh -XY <span class="variable">$user</span>@<span class="variable">$host</span></span><br><span class="line">expect <span class="string">&quot;*password:*&quot;</span></span><br><span class="line">send <span class="string">&quot;<span class="variable">$password</span>\r&quot;</span></span><br><span class="line">interact</span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure><p>简述下逻辑就是，</p><ol><li>在本地你想存在命令的地方建个文件夹</li><li>把上面的代码写好，保存进去</li><li>然后在iterm2里配置好</li><li>之后iterm2就可以一键执行代码了，用来登录服务器，并窗口可以自适应<br>具体可以看原文</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;转载自&lt;a href=&quot;https://zhuanlan.zhihu.com/p/180500618&quot;&gt;https://zhuanlan.zhihu.com/p/180500618&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;原文中代码存在bug，已修改，如下：&lt;/p&gt;</summary>
    
    
    
    <category term="工具" scheme="https://yongmaple.com/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="iTerm2" scheme="https://yongmaple.com/tags/iTerm2/"/>
    
  </entry>
  
</feed>
